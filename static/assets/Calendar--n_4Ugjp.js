import{a as ue,u as xe,r as a,b as j,j as e,k as U,X as he,g as V}from"./index-B1SpUUbW.js";import{M as Z}from"./Modal-oPG5y50X.js";import{C as be}from"./chevron-left-Dq96yRIJ.js";import{C as ge}from"./chevron-right-hCmB2CU_.js";import{L as ee}from"./loader-circle-DQqyjO1O.js";import{A as pe,S as fe}from"./slash-CvtjRTP_.js";import{C as te}from"./clock-D083iAFm.js";import"./index-C21_59zD.js";import"./proxy-B6TPh4oX.js";function L(l){return l.toISOString().slice(0,10)}function c(l,u){const d=new Date(l+"T00:00:00");return d.setDate(d.getDate()+u),d.toISOString().slice(0,10)}const ye=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function je(l,u){const d=new Date().toISOString().slice(0,10);return l.status==="verified"?{border:"border-emerald",bg:"bg-emerald/10",icon:e.jsx(V,{size:16,className:"text-emerald"})}:l.status==="completed"?{border:"border-emerald",bg:"bg-emerald/5",icon:e.jsx(V,{size:16,className:"text-emerald/60"})}:l.status==="skipped"?{border:"border-border",bg:"bg-navy-light/50",icon:e.jsx(fe,{size:16,className:"text-muted"}),textClass:"line-through text-muted"}:u<d?{border:"border-crimson",bg:"bg-crimson/5",icon:e.jsx(te,{size:16,className:"text-crimson"})}:{border:"border-border",bg:"",icon:e.jsx(te,{size:16,className:"text-muted"})}}function ze(){var Y,B,G;const l=ue(),{user:u}=xe(),d=(u==null?void 0:u.role)==="kid",[i,_]=a.useState(()=>L(new Date)),[A,se]=a.useState({}),[z,q]=a.useState(!0),[E,O]=a.useState(""),[ae,N]=a.useState(!1),[h,re]=a.useState(null),[K,F]=a.useState([]),[v,I]=a.useState(""),[M,P]=a.useState(!1),[Q,S]=a.useState(""),[W,H]=a.useState(null),[r,k]=a.useState(null),p=a.useCallback(async()=>{var t,x,n;q(!0),O("");try{const w=new Date(i+"T00:00:00").getDay(),$=w===0?-6:1-w,y=c(i,$),s=await j(`/api/calendar?week_start=${y}`),m={};for(let o=0;o<7;o++){const b=c(i,o);m[b]=((t=s.days)==null?void 0:t[b])||[]}const C=c(y,7),D=c(i,6),T=c(y,6);if(D>T)try{const o=await j(`/api/calendar?week_start=${C}`);for(let b=0;b<7;b++){const g=c(i,b);!((x=m[g])!=null&&x.length)&&((n=o.days)!=null&&n[g])&&(m[g]=o.days[g])}}catch{}se(m)}catch(f){O(f.message||"Failed to load calendar")}finally{q(!1)}},[i]);a.useEffect(()=>{p()},[p]),a.useEffect(()=>{const t=()=>{p()};return window.addEventListener("ws:message",t),()=>window.removeEventListener("ws:message",t)},[p]);const ne=()=>_(c(i,-7)),ie=()=>_(c(i,7)),oe=()=>_(L(new Date)),ce=async t=>{re(t),S(""),I(""),N(!0);try{const n=(await j("/api/stats/kids")||[]).filter(f=>f.id!==u.id);F(n)}catch{F([])}},le=async()=>{if(!v){S("Select a hero to trade with");return}P(!0),S("");try{await j("/api/calendar/trade",{method:"POST",body:{assignment_id:h.id,target_user_id:v}}),N(!1),p()}catch(t){S(t.message||"Trade failed")}finally{P(!1)}},R=async(t,x=!1)=>{H(t),k(null);try{await j(`/api/calendar/assignments/${t}${x?"?all_future=true":""}`,{method:"DELETE"}),p()}catch(n){O(n.message||"Failed to remove quest")}finally{H(null)}},de=c(i,6),J=L(new Date),me=i===J,X=t=>new Date(t+"T00:00:00").toLocaleDateString(void 0,{month:"short",day:"numeric"});return e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(U,{size:28,className:"text-sky"}),e.jsx("h1",{className:"text-cream text-xl font-extrabold leading-relaxed",children:"Quest Calendar"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:ne,className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-cream","aria-label":"Previous week",children:e.jsx(be,{size:20})}),e.jsxs("span",{className:"text-cream text-sm min-w-[180px] text-center",children:[X(i)," â€“ ",X(de)]}),e.jsx("button",{onClick:ie,className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-cream","aria-label":"Next 7 days",children:e.jsx(ge,{size:20})}),!me&&e.jsx("button",{onClick:oe,className:"game-btn game-btn-blue ml-2",children:"Today"})]})]}),E&&e.jsx("div",{className:"mb-4 p-3 rounded border-2 border-crimson/40 bg-crimson/10 text-crimson text-sm text-center",children:E}),z&&e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx(ee,{size:32,className:"text-sky animate-spin"})}),!z&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-7 gap-3",children:Array.from({length:7},(t,x)=>{const n=c(i,x),f=new Date(n+"T00:00:00"),w=ye[f.getDay()],$=n===J,y=A[n]||[];return e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:`text-center py-2 px-1 rounded-t-md border-b-2 ${$?"bg-sky/10 border-sky text-sky":"bg-surface-raised/30 border-border text-muted"}`,children:[e.jsx("div",{className:"text-xs font-bold tracking-wider",children:w}),e.jsx("div",{className:"text-sm mt-1",children:new Date(n+"T00:00:00").getDate()})]}),e.jsxs("div",{className:"space-y-2 mt-2 min-h-[80px]",children:[y.length===0&&e.jsx("p",{className:"text-muted text-xs text-center py-4",children:"No quests"}),y.map(s=>{var C,D,T;const m=je(s,n);return e.jsxs("div",{className:`game-panel !border-2 ${m.border} ${m.bg} p-2 cursor-pointer hover:brightness-110 transition-all`,onClick:()=>l(`/chores/${s.chore_id||s.id}`),children:[e.jsxs("div",{className:"flex items-start gap-1.5",children:[m.icon,e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:`text-sm leading-tight truncate ${m.textClass||"text-cream"}`,children:((C=s.chore)==null?void 0:C.title)||s.chore_title||"Quest"}),!d&&(((D=s.user)==null?void 0:D.display_name)||s.assigned_to_name)&&e.jsx("p",{className:"text-xs text-purple font-medium mt-0.5 truncate",children:((T=s.user)==null?void 0:T.display_name)||s.assigned_to_name})]})]}),d&&s.status==="pending"&&e.jsxs("button",{onClick:o=>{o.stopPropagation(),ce(s)},className:"mt-1.5 flex items-center gap-1 text-xs font-medium text-sky hover:text-sky/80 transition-colors",children:[e.jsx(pe,{size:12}),"Trade"]}),!d&&s.status==="pending"&&e.jsxs("button",{onClick:o=>{var g;o.stopPropagation(),((g=s.chore)==null?void 0:g.recurrence)&&s.chore.recurrence!=="once"?k(s):R(s.id)},disabled:W===s.id,className:"mt-1.5 flex items-center gap-1 text-xs font-medium text-crimson hover:text-crimson/80 transition-colors",children:[W===s.id?e.jsx(ee,{size:12,className:"animate-spin"}):e.jsx(he,{size:12}),"Remove"]})]},s.id)})]})]},n)})}),!z&&!E&&Object.values(A).every(t=>t.length===0)&&e.jsxs("div",{className:"text-center py-16",children:[e.jsx(U,{size:48,className:"text-muted mx-auto mb-4"}),e.jsx("p",{className:"text-cream text-lg font-bold",children:"No quests scheduled this week"}),e.jsx("p",{className:"text-muted text-sm mt-2",children:"The quest board is empty. Time to plan new adventures!"})]}),e.jsx(Z,{isOpen:ae,onClose:()=>N(!1),title:"Propose a Trade",actions:[{label:"Cancel",onClick:()=>N(!1),className:"game-btn game-btn-red"},{label:M?"Sending...":"Send Trade",onClick:le,className:"game-btn game-btn-blue",disabled:M||!v}],children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-muted text-sm",children:["Trade"," ",e.jsx("span",{className:"text-cream font-bold",children:((Y=h==null?void 0:h.chore)==null?void 0:Y.title)||(h==null?void 0:h.chore_title)||"Quest"})," ","with another hero:"]}),Q&&e.jsx("div",{className:"p-2 rounded border border-crimson/40 bg-crimson/10 text-crimson text-sm",children:Q}),K.length===0?e.jsx("p",{className:"text-muted text-sm",children:"No other heroes found in your party."}):e.jsx("div",{className:"space-y-2",children:K.map(t=>e.jsx("button",{onClick:()=>I(t.id),className:`w-full text-left p-3 rounded border-2 transition-colors ${v===t.id?"border-sky bg-sky/10 text-sky":"border-border text-muted hover:border-cream/30"}`,children:e.jsx("span",{className:"text-sm",children:t.display_name||t.username})},t.id))})]})}),e.jsx(Z,{isOpen:!!r,onClose:()=>k(null),title:"Remove Recurring Quest",actions:[{label:"Cancel",onClick:()=>k(null),className:"game-btn game-btn-blue"},{label:"Just This One",onClick:()=>R(r==null?void 0:r.id,!1),className:"game-btn game-btn-red"},{label:"All Future",onClick:()=>R(r==null?void 0:r.id,!0),className:"game-btn game-btn-red"}],children:e.jsxs("p",{className:"text-muted text-sm",children:[e.jsx("span",{className:"text-cream font-bold",children:((B=r==null?void 0:r.chore)==null?void 0:B.title)||"Quest"})," ","is a recurring quest",(G=r==null?void 0:r.user)!=null&&G.display_name?` for ${r.user.display_name}`:"",". Remove just this one instance, or all future pending instances for this kid?"]})})]})}export{ze as default};
