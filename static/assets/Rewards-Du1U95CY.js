import{u as ie,r as a,b as o,j as s,G as ne}from"./index-_mTouwGG.js";import{M as I}from"./Modal-DO4j2ktb.js";import{S as B,C as N,P as oe}from"./shopping-bag-DAlihhAd.js";import{P as G}from"./plus-Bhr-M1Gy.js";import{S as re}from"./sparkles-C4TLH_NZ.js";import{P as ce}from"./pencil-DbluJPrl.js";import{T as de}from"./trash-2-Cwqu3oKx.js";import{C as me}from"./clock-ColZaMv0.js";import{C as xe}from"./circle-check-Z0twjO-L.js";import{C as pe}from"./circle-x-1wh3lYYE.js";import"./index-Bh2TBjIQ.js";import"./proxy-ot5MUewZ.js";const H={title:"",description:"",point_cost:50,icon:"",stock:"",auto_approve_threshold:""};function Se(){const{user:i}=ie(),d=(i==null?void 0:i.role)==="parent"||(i==null?void 0:i.role)==="admin",T=(i==null?void 0:i.role)==="kid",[P,K]=a.useState([]),[v,U]=a.useState([]),[Y,q]=a.useState(!0),[R,u]=a.useState(""),[W,y]=a.useState(!1),[g,k]=a.useState(null),[l,C]=a.useState({...H}),[E,r]=a.useState(""),[z,A]=a.useState(!1),[m,f]=a.useState(null),[O,$]=a.useState(!1),[w,L]=a.useState(null),[h,S]=a.useState(""),[J,b]=a.useState(null),M=(i==null?void 0:i.points_balance)??0,c=a.useCallback(async()=>{try{u("");const e=await o("/api/rewards");K(Array.isArray(e)?e:e.rewards||e.items||[])}catch(e){u(e.message||"The treasure shop is temporarily closed.")}},[]),x=a.useCallback(async()=>{if(d)try{const e=await o("/api/rewards/redemptions?status=pending");U(Array.isArray(e)?e:e.redemptions||e.items||[])}catch{}},[d]);a.useEffect(()=>{Promise.all([c(),x()]).finally(()=>q(!1))},[c,x]),a.useEffect(()=>{const e=()=>{c(),x()};return window.addEventListener("ws:message",e),()=>window.removeEventListener("ws:message",e)},[c,x]);const X=()=>{k(null),C({...H}),r(""),y(!0)},Q=e=>{k(e),C({title:e.title||"",description:e.description||"",point_cost:e.point_cost??e.cost??50,icon:e.icon||"",stock:e.stock!=null?String(e.stock):"",auto_approve_threshold:e.auto_approve_threshold!=null?String(e.auto_approve_threshold):""}),r(""),y(!0)},_=()=>{y(!1),k(null),r("")},p=(e,t)=>{C(n=>({...n,[e]:t}))},V=async()=>{if(!l.title.trim()){r("Every treasure needs a name!");return}if(Number(l.point_cost)<1){r("The cost must be at least 1 XP.");return}A(!0),r("");const e={title:l.title.trim(),description:l.description.trim(),point_cost:Number(l.point_cost),icon:l.icon||void 0};l.stock!==""&&(e.stock=Number(l.stock)),l.auto_approve_threshold!==""&&(e.auto_approve_threshold=Number(l.auto_approve_threshold));try{g?await o(`/api/rewards/${g.id}`,{method:"PUT",body:e}):await o("/api/rewards",{method:"POST",body:e}),_(),await c()}catch(t){r(t.message||"Could not save the treasure.")}finally{A(!1)}},Z=async()=>{if(m){$(!0);try{await o(`/api/rewards/${m.id}`,{method:"DELETE"}),f(null),await c()}catch(e){u(e.message||"Failed to remove the treasure.")}finally{$(!1)}}},ee=async e=>{L(e.id),S("");try{await o(`/api/rewards/${e.id}/redeem`,{method:"POST"}),S(`You claimed "${e.title}"! Check your inventory, hero!`),await c()}catch(t){S(t.message||"Redemption failed. The shopkeeper is confused.")}finally{L(null)}},se=async e=>{b(e.id);try{await o(`/api/rewards/redemptions/${e.id}/approve`,{method:"POST"}),await x()}catch(t){u(t.message||"Could not approve redemption.")}finally{b(null)}},te=async e=>{b(e.id);try{await o(`/api/rewards/redemptions/${e.id}/deny`,{method:"POST"}),await x()}catch(t){u(t.message||"Could not deny redemption.")}finally{b(null)}},ae=e=>M>=(e.point_cost??e.cost??0),le=e=>e.stock!=null&&e.stock<=0;return Y?s.jsxs("div",{className:"flex flex-col items-center justify-center py-20 gap-4",children:[s.jsx(B,{size:48,className:"text-sky animate-pulse"}),s.jsx("p",{className:"text-cream text-lg font-bold animate-pulse",children:"The shopkeeper is arranging the treasures..."})]}):s.jsxs("div",{className:"max-w-5xl mx-auto space-y-6",children:[s.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(B,{size:28,className:"text-sky"}),s.jsx("h1",{className:"text-cream text-xl font-extrabold leading-relaxed",children:"Treasure Shop"})]}),d&&s.jsxs("button",{onClick:X,className:"game-btn game-btn-blue flex items-center gap-2",children:[s.jsx(G,{size:16}),"Add Treasure"]})]}),T&&s.jsx("div",{className:"game-panel p-5",children:s.jsxs("div",{className:"flex items-center justify-center gap-4",children:[s.jsx("div",{className:"w-14 h-14 rounded-full bg-gold/20 border-2 border-gold/40 flex items-center justify-center",children:s.jsx(N,{size:28,className:"text-gold"})}),s.jsxs("div",{className:"text-center",children:[s.jsx("p",{className:"text-muted text-sm",children:"Your XP Balance"}),s.jsxs("p",{className:"text-gold text-xl font-extrabold",children:[M.toLocaleString()," XP"]})]})]})}),R&&s.jsx("div",{className:"p-3 rounded border-2 border-crimson/40 bg-crimson/10 text-crimson text-sm text-center",children:R}),h&&s.jsx("div",{className:`p-3 rounded border-2 text-sm text-center ${h.toLowerCase().includes("fail")||h.toLowerCase().includes("confused")||h.toLowerCase().includes("insufficient")?"border-crimson/40 bg-crimson/10 text-crimson":"border-emerald/40 bg-emerald/10 text-emerald"}`,children:h}),P.length===0?s.jsxs("div",{className:"game-panel p-10 text-center",children:[s.jsx(ne,{size:48,className:"mx-auto text-cream/20 mb-4"}),s.jsx("p",{className:"text-muted text-sm",children:"The treasure shop is empty. No loot to be found... yet!"}),d&&s.jsxs("button",{onClick:X,className:"game-btn game-btn-blue mt-4 inline-flex items-center gap-2",children:[s.jsx(G,{size:16}),"Stock First Treasure"]})]}):s.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-3",children:P.map(e=>{const t=le(e),n=ae(e),j=e.point_cost??e.cost??0;return s.jsxs("div",{className:`game-panel p-5 flex flex-col gap-3 relative ${t?"opacity-60":""}`,children:[s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx("div",{className:"w-12 h-12 rounded-lg bg-sky/10 border border-sky/20 flex items-center justify-center flex-shrink-0",children:e.icon?s.jsx("span",{className:"text-2xl",children:e.icon}):s.jsx(re,{size:22,className:"text-sky"})}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("h3",{className:"text-cream text-lg font-bold leading-relaxed",children:e.title}),e.description&&s.jsx("p",{className:"text-muted text-sm mt-1 line-clamp-2",children:e.description})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(N,{size:16,className:"text-gold"}),s.jsxs("span",{className:"text-gold text-sm font-bold",children:[j," XP"]})]}),e.stock!=null&&s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx(oe,{size:14,className:t?"text-crimson":"text-muted"}),t?s.jsx("span",{className:"text-crimson text-xs font-bold",children:"Sold Out"}):s.jsxs("span",{className:"text-muted text-xs",children:[e.stock," left"]})]}),s.jsxs("div",{className:"flex items-center gap-2 mt-auto pt-2",children:[T&&s.jsxs("button",{onClick:()=>ee(e),disabled:!n||t||w===e.id,className:`game-btn game-btn-gold flex-1 flex items-center justify-center gap-2 ${!n||t?"opacity-40 cursor-not-allowed":""} ${w===e.id?"opacity-60 cursor-wait":""}`,children:[s.jsx(N,{size:14}),w===e.id?"Claiming...":n?t?"Sold Out":"Redeem":"Not Enough XP"]}),d&&s.jsxs(s.Fragment,{children:[s.jsx("button",{onClick:()=>Q(e),className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-sky","aria-label":"Edit reward",children:s.jsx(ce,{size:16})}),s.jsx("button",{onClick:()=>f(e),className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-crimson","aria-label":"Delete reward",children:s.jsx(de,{size:16})})]})]})]},e.id)})}),d&&v.length>0&&s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(me,{size:20,className:"text-sky"}),s.jsx("h2",{className:"text-cream text-lg font-bold",children:"Pending Redemptions"}),s.jsx("span",{className:"ml-auto bg-sky/20 text-sky text-xs font-bold px-2 py-1 rounded-full",children:v.length})]}),s.jsx("div",{className:"space-y-3",children:v.map(e=>{var n,j,D,F;const t=J===e.id;return s.jsxs("div",{className:"game-panel p-4 flex flex-col sm:flex-row items-start sm:items-center gap-4",children:[s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("p",{className:"text-cream text-base font-bold leading-relaxed",children:e.reward_title||((n=e.reward)==null?void 0:n.title)||"Reward"}),s.jsxs("div",{className:"flex items-center gap-3 mt-1 flex-wrap",children:[s.jsxs("span",{className:"text-muted text-sm",children:["Requested by"," ",s.jsx("span",{className:"text-sky",children:e.kid_name||((j=e.user)==null?void 0:j.display_name)||((D=e.user)==null?void 0:D.username)||"Hero"})]}),s.jsxs("span",{className:"flex items-center gap-1 text-gold text-xs",children:[s.jsx(N,{size:12}),e.points_spent||e.points||((F=e.reward)==null?void 0:F.point_cost)||0," XP"]})]})]}),s.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[s.jsxs("button",{onClick:()=>se(e),disabled:t,className:`game-btn game-btn-blue flex items-center gap-1 ${t?"opacity-60 cursor-wait":""}`,children:[s.jsx(xe,{size:14}),"Approve"]}),s.jsxs("button",{onClick:()=>te(e),disabled:t,className:`game-btn game-btn-red flex items-center gap-1 ${t?"opacity-60 cursor-wait":""}`,children:[s.jsx(pe,{size:14}),"Deny"]})]})]},e.id)})})]}),s.jsx(I,{isOpen:W,onClose:_,title:g?"Edit Treasure":"New Treasure",actions:[{label:"Cancel",onClick:_,className:"game-btn game-btn-blue"},{label:z?"Saving...":g?"Update Treasure":"Add Treasure",onClick:V,className:"game-btn game-btn-gold",disabled:z}],children:s.jsxs("div",{className:"space-y-4",children:[E&&s.jsx("div",{className:"p-2 rounded border border-crimson/40 bg-crimson/10 text-crimson text-sm",children:E}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Treasure Name"}),s.jsx("input",{type:"text",value:l.title,onChange:e=>p("title",e.target.value),placeholder:"Extra Screen Time",className:"field-input"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Description"}),s.jsx("textarea",{value:l.description,onChange:e=>p("description",e.target.value),placeholder:"What does this treasure grant?",rows:3,className:"field-input resize-none"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Cost (XP)"}),s.jsx("input",{type:"number",min:1,value:l.point_cost,onChange:e=>p("point_cost",e.target.value),className:"field-input"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Icon (Emoji)"}),s.jsx("input",{type:"text",value:l.icon,onChange:e=>p("icon",e.target.value),placeholder:"e.g. trophy, star, gift",className:"field-input"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Stock (Optional)"}),s.jsx("input",{type:"number",min:0,value:l.stock,onChange:e=>p("stock",e.target.value),placeholder:"Leave empty for unlimited",className:"field-input"}),s.jsx("p",{className:"text-muted text-xs mt-1",children:"Leave empty for unlimited supply."})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Auto-Approve Threshold (Optional)"}),s.jsx("input",{type:"number",min:0,value:l.auto_approve_threshold,onChange:e=>p("auto_approve_threshold",e.target.value),placeholder:"Max cost to auto-approve",className:"field-input"}),s.jsx("p",{className:"text-muted text-xs mt-1",children:"Redemptions at or below this cost are auto-approved."})]})]})}),s.jsx(I,{isOpen:!!m,onClose:()=>f(null),title:"Remove Treasure?",actions:[{label:"Keep Treasure",onClick:()=>f(null),className:"game-btn game-btn-blue"},{label:O?"Removing...":"Remove Treasure",onClick:Z,className:"game-btn game-btn-red",disabled:O}],children:s.jsxs("p",{className:"text-muted",children:["Are you sure you want to remove"," ",s.jsxs("span",{className:"text-gold font-bold",children:['"',m==null?void 0:m.title,'"']})," ","from the treasure shop? Heroes can no longer redeem this reward."]})})]})}export{Se as default};
