import{u as ne,a as oe,r as i,b as m,j as s,S}from"./index-_mTouwGG.js";import{M as $}from"./Modal-DO4j2ktb.js";import{P as I}from"./plus-Bhr-M1Gy.js";import{F as ce,S as de,B as me}from"./search-VUdMKEFw.js";import{P as ue}from"./pencil-DbluJPrl.js";import{T as xe}from"./trash-2-Cwqu3oKx.js";import{C as U}from"./camera-BmvNStLQ.js";import{S as pe}from"./star-NY0cNry0.js";import{R as ge}from"./refresh-cw-D_RWwdJ2.js";import"./index-Bh2TBjIQ.js";import"./proxy-ot5MUewZ.js";const B=[{value:"easy",label:"Easy",level:1},{value:"medium",label:"Medium",level:2},{value:"hard",label:"Hard",level:3},{value:"expert",label:"Expert",level:4}],fe={easy:1,medium:2,hard:3,expert:4},he=[{value:"once",label:"One-time"},{value:"daily",label:"Daily"},{value:"weekly",label:"Weekly"},{value:"custom",label:"Custom Days"}],Y=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],K={cleaning:"bg-sky/20 text-sky border-sky/40",cooking:"bg-gold/20 text-gold border-gold/40",outdoor:"bg-emerald/20 text-emerald border-emerald/40",homework:"bg-purple/20 text-purple border-purple/40",pet_care:"bg-crimson/20 text-crimson border-crimson/40",laundry:"bg-sky/20 text-sky border-sky/40",errands:"bg-gold/20 text-gold border-gold/40",default:"bg-cream/10 text-muted border-border"},f="bg-navy-light border-2 border-border text-cream p-2 rounded text-sm focus:border-sky focus:outline-none transition-colors";function be({level:l}){const n=typeof l=="string"?fe[l]||1:l||1;return s.jsx("div",{className:"flex items-center gap-0.5",children:[1,2,3,4].map(r=>s.jsx(pe,{size:14,className:r<=n?"text-gold fill-gold":"text-muted"},r))})}function ye({category:l}){const n=typeof l=="object"?l==null?void 0:l.name:l,r=K[n==null?void 0:n.toLowerCase()]||K.default;return s.jsx("span",{className:`inline-block px-2 py-0.5 rounded-full text-xs border ${r} capitalize`,children:n||"General"})}function je({recurrence:l,customDays:n}){return!l||l==="once"?null:s.jsxs("div",{className:"flex items-center gap-1 text-muted text-xs",children:[s.jsx(ge,{size:12}),s.jsx("span",{className:"capitalize",children:l}),l==="custom"&&(n==null?void 0:n.length)>0&&s.jsxs("span",{className:"text-muted",children:["(",n.map(r=>Y[r]||r).join(", "),")"]})]})}const X={title:"",description:"",points:10,difficulty:"easy",category_id:"",recurrence:"once",custom_days:[],requires_photo:!1,assigned_user_ids:[]};function Ae(){const{user:l}=ne(),n=oe(),r=(l==null?void 0:l.role)==="parent"||(l==null?void 0:l.role)==="admin",[u,G]=i.useState([]),[q,H]=i.useState([]),[E,P]=i.useState([]),[W,V]=i.useState(!0),[T,j]=i.useState(""),[v,J]=i.useState(""),[N,Z]=i.useState(""),[b,ee]=i.useState(""),[se,_]=i.useState(!1),[h,C]=i.useState(null),[a,x]=i.useState({...X}),[A,c]=i.useState(""),[D,w]=i.useState(!1),[p,y]=i.useState(null),[z,F]=i.useState(!1),g=i.useCallback(async()=>{try{j("");const e=await m("/api/chores");G(Array.isArray(e)?e:e.chores||e.items||[])}catch(e){j(e.message||"Failed to load quests from the guild board.")}},[]),L=i.useCallback(async()=>{try{const e=await m("/api/chores/categories");H(Array.isArray(e)?e:e.categories||[])}catch{}},[]),R=i.useCallback(async()=>{if(r)try{const e=await m("/api/stats/family");P(Array.isArray(e)?e:[])}catch{try{const e=await m("/api/admin/users"),t=Array.isArray(e)?e:e.users||[];P(t.filter(o=>o.role==="kid"))}catch{}}},[r]);i.useEffect(()=>{Promise.all([g(),L(),R()]).finally(()=>V(!1))},[g,L,R]),i.useEffect(()=>{const e=()=>{g()};return window.addEventListener("ws:message",e),()=>window.removeEventListener("ws:message",e)},[g]);const Q=u.filter(e=>{var t,o,O;return!(v&&((t=e.category)==null?void 0:t.name)!==v||N&&e.difficulty!==N||b&&!((o=e.title)!=null&&o.toLowerCase().includes(b.toLowerCase()))&&!((O=e.description)!=null&&O.toLowerCase().includes(b.toLowerCase())))}),M=()=>{C(null),x({...X}),c(""),_(!0)},te=e=>{C(e),x({title:e.title||"",description:e.description||"",points:e.points||10,difficulty:e.difficulty||"easy",category_id:e.category_id||"",recurrence:e.recurrence||"once",custom_days:e.custom_days||[],requires_photo:e.requires_photo||!1,assigned_user_ids:e.assigned_user_ids||e.assigned_kids||e.assigned_to||[]}),c(""),_(!0)},k=()=>{_(!1),C(null),c("")},d=(e,t)=>{x(o=>({...o,[e]:t}))},ae=e=>{x(t=>({...t,custom_days:t.custom_days.includes(e)?t.custom_days.filter(o=>o!==e):[...t.custom_days,e]}))},le=e=>{x(t=>({...t,assigned_user_ids:t.assigned_user_ids.includes(e)?t.assigned_user_ids.filter(o=>o!==e):[...t.assigned_user_ids,e]}))},ie=async()=>{if(!a.title.trim()){c("Every quest needs a name, adventurer!");return}if(a.points<1){c("The reward must be at least 1 XP.");return}w(!0),c("");const e={title:a.title.trim(),description:a.description.trim()||null,points:Number(a.points),difficulty:a.difficulty,category_id:a.category_id?Number(a.category_id):void 0,recurrence:a.recurrence,requires_photo:a.requires_photo,assigned_user_ids:a.assigned_user_ids.length>0?a.assigned_user_ids:[]};if(!e.category_id){c("Please select a category for this quest."),w(!1);return}a.recurrence==="custom"&&(e.custom_days=a.custom_days);try{h?await m(`/api/chores/${h.id}`,{method:"PUT",body:e}):await m("/api/chores",{method:"POST",body:e}),k(),await g()}catch(t){c(t.message||"The quest scroll could not be saved.")}finally{w(!1)}},re=async()=>{if(p){F(!0);try{await m(`/api/chores/${p.id}`,{method:"DELETE"}),y(null),await g()}catch(e){j(e.message||"Failed to remove the quest.")}finally{F(!1)}}};return W?s.jsxs("div",{className:"flex flex-col items-center justify-center py-20 gap-4",children:[s.jsx(S,{size:48,className:"text-sky animate-pulse"}),s.jsx("p",{className:"text-cream text-lg font-bold animate-pulse",children:"Loading quests from the guild board..."})]}):s.jsxs("div",{className:"max-w-5xl mx-auto space-y-6",children:[s.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(S,{size:28,className:"text-sky"}),s.jsx("h1",{className:"text-cream text-xl font-extrabold leading-relaxed",children:r?"Quest Management":"My Quests"})]}),r&&s.jsxs("button",{onClick:M,className:"game-btn game-btn-blue flex items-center gap-2",children:[s.jsx(I,{size:16}),"Create Quest"]})]}),T&&s.jsx("div",{className:"p-3 rounded border-2 border-crimson/40 bg-crimson/10 text-crimson text-sm text-center",children:T}),s.jsx("div",{className:"game-panel p-4",children:s.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-3",children:[s.jsxs("div",{className:"flex items-center gap-2 text-muted",children:[s.jsx(ce,{size:16}),s.jsx("span",{className:"text-sm",children:"Filters:"})]}),s.jsxs("div",{className:"relative flex-1 min-w-0",children:[s.jsx(de,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted"}),s.jsx("input",{type:"text",placeholder:"Search quests...",value:b,onChange:e=>ee(e.target.value),className:"field-input pl-9 py-2"})]}),s.jsxs("select",{value:v,onChange:e=>J(e.target.value),className:f,children:[s.jsx("option",{value:"",children:"All Categories"}),q.map(e=>s.jsx("option",{value:e.name,children:e.name},e.id))]}),s.jsxs("select",{value:N,onChange:e=>Z(e.target.value),className:f,children:[s.jsx("option",{value:"",children:"All Difficulties"}),B.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))]})]})}),Q.length===0?s.jsxs("div",{className:"game-panel p-10 text-center",children:[s.jsx(S,{size:40,className:"mx-auto text-muted mb-4"}),s.jsx("p",{className:"text-muted text-sm",children:u.length===0?"The quest board is empty. No adventures await... yet!":"No quests match your search. Try adjusting the filters."}),r&&u.length===0&&s.jsxs("button",{onClick:M,className:"game-btn game-btn-blue mt-4 inline-flex items-center gap-2",children:[s.jsx(I,{size:16}),"Post First Quest"]})]}):s.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-3",children:Q.map(e=>s.jsxs("div",{className:"game-panel p-4 flex flex-col gap-3 cursor-pointer hover:border-sky/40 transition-colors",onClick:()=>n(`/chores/${e.id}`),children:[s.jsxs("div",{className:"flex items-start justify-between gap-2",children:[s.jsx("h3",{className:"text-cream text-lg font-bold leading-relaxed flex-1",children:e.title}),r&&s.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[s.jsx("button",{onClick:t=>{t.stopPropagation(),te(e)},className:"p-1.5 rounded hover:bg-surface-raised transition-colors text-muted hover:text-sky","aria-label":"Edit quest",children:s.jsx(ue,{size:14})}),s.jsx("button",{onClick:t=>{t.stopPropagation(),y(e)},className:"p-1.5 rounded hover:bg-surface-raised transition-colors text-muted hover:text-crimson","aria-label":"Delete quest",children:s.jsx(xe,{size:14})})]})]}),e.description&&s.jsx("p",{className:"text-muted text-sm line-clamp-2",children:e.description}),s.jsxs("div",{className:"flex items-center flex-wrap gap-2 mt-auto",children:[s.jsxs("span",{className:"flex items-center gap-1 text-gold font-bold text-sm",children:[s.jsx("span",{className:"text-lg",children:"â˜…"}),e.points," XP"]}),s.jsx(be,{level:e.difficulty||1})]}),s.jsxs("div",{className:"flex items-center flex-wrap gap-2",children:[s.jsx(ye,{category:e.category}),s.jsx(je,{recurrence:e.recurrence,customDays:e.custom_days}),e.requires_photo&&s.jsxs("span",{className:"flex items-center gap-1 text-muted text-xs",children:[s.jsx(U,{size:12}),"Photo"]})]})]},e.id))}),s.jsx($,{isOpen:se,onClose:k,title:h?"Edit Quest Scroll":"New Quest Scroll",actions:[{label:"Cancel",onClick:k,className:"game-btn game-btn-blue"},{label:D?"Saving...":h?"Update Quest":"Create Quest",onClick:ie,className:"game-btn game-btn-gold",disabled:D}],children:s.jsxs("div",{className:"space-y-4",children:[A&&s.jsx("div",{className:"p-2 rounded border border-crimson/40 bg-crimson/10 text-crimson text-sm",children:A}),!h&&u.length>0&&s.jsxs("div",{children:[s.jsxs("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide flex items-center gap-1.5",children:[s.jsx(me,{size:14}),"Start from existing quest"]}),s.jsxs("select",{value:"",onChange:e=>{const t=u.find(o=>String(o.id)===e.target.value);t&&x({title:t.title||"",description:t.description||"",points:t.points||10,difficulty:t.difficulty||"easy",category_id:t.category_id||"",recurrence:t.recurrence||"once",custom_days:t.custom_days||[],requires_photo:t.requires_photo||!1,assigned_user_ids:[]})},className:`${f} w-full p-3`,children:[s.jsx("option",{value:"",children:"Create from scratch..."}),u.map(e=>s.jsxs("option",{value:e.id,children:[e.title," (",e.points," XP, ",e.difficulty,")"]},e.id))]}),s.jsx("p",{className:"text-muted text-xs mt-1",children:"Pick a quest to pre-fill the form, then customise as needed."})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Quest Name"}),s.jsx("input",{type:"text",value:a.title,onChange:e=>d("title",e.target.value),placeholder:"Defeat the Dust Bunnies",className:"field-input"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Description"}),s.jsx("textarea",{value:a.description,onChange:e=>d("description",e.target.value),placeholder:"Describe the quest details...",rows:3,className:"field-input resize-none"})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"XP Reward"}),s.jsx("input",{type:"number",min:1,value:a.points,onChange:e=>d("points",e.target.value),className:"field-input"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Difficulty"}),s.jsx("select",{value:a.difficulty,onChange:e=>d("difficulty",e.target.value),className:`${f} w-full p-3`,children:B.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Category"}),s.jsxs("select",{value:a.category_id,onChange:e=>d("category_id",e.target.value),className:`${f} w-full p-3`,children:[s.jsx("option",{value:"",children:"Select category..."}),q.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Recurrence"}),s.jsx("select",{value:a.recurrence,onChange:e=>d("recurrence",e.target.value),className:`${f} w-full p-3`,children:he.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))})]}),a.recurrence==="custom"&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-2 tracking-wide",children:"Quest Days"}),s.jsx("div",{className:"flex flex-wrap gap-2",children:Y.map((e,t)=>s.jsx("button",{type:"button",onClick:()=>ae(t),className:`px-3 py-1.5 rounded border-2 text-sm transition-colors ${a.custom_days.includes(t)?"border-sky bg-sky/20 text-sky":"border-border text-muted hover:border-cream/30"}`,children:e},e))})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("label",{className:"text-cream text-sm font-medium tracking-wide flex items-center gap-2",children:[s.jsx(U,{size:14}),"Requires Photo Proof"]}),s.jsx("button",{type:"button",onClick:()=>d("requires_photo",!a.requires_photo),className:`relative w-12 h-6 rounded-full border-2 transition-colors ${a.requires_photo?"bg-sky/20 border-sky":"bg-navy-light border-border"}`,children:s.jsx("div",{className:`absolute top-0.5 w-4 h-4 rounded-full transition-all ${a.requires_photo?"left-6 bg-sky":"left-0.5 bg-muted"}`})})]}),E.length>0&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-2 tracking-wide",children:"Assign to Heroes"}),s.jsx("div",{className:"space-y-2",children:E.map(e=>s.jsxs("label",{className:"flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-surface-raised/50 transition-colors",children:[s.jsx("input",{type:"checkbox",checked:a.assigned_user_ids.includes(e.id),onChange:()=>le(e.id),className:"w-4 h-4 accent-sky"}),s.jsx("span",{className:"text-cream text-sm",children:e.display_name||e.username})]},e.id))})]})]})}),s.jsx($,{isOpen:!!p,onClose:()=>y(null),title:"Abandon Quest?",actions:[{label:"Keep Quest",onClick:()=>y(null),className:"game-btn game-btn-blue"},{label:z?"Removing...":"Remove Quest",onClick:re,className:"game-btn game-btn-red",disabled:z}],children:s.jsxs("p",{className:"text-muted",children:["Are you sure you want to remove the quest"," ",s.jsxs("span",{className:"text-cream text-lg font-bold",children:['"',p==null?void 0:p.title,'"']}),"? This action cannot be undone. All associated records will be archived."]})})]})}export{Ae as default};
