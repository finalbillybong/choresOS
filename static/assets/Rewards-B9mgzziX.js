import{c as P,u as ie,r as a,b as i,j as e,G as re}from"./index-DbTTv7ag.js";import{M as V}from"./Modal-Bj2NyloF.js";import{P as q}from"./plus-CMcvfJKm.js";import{S as ce}from"./sparkles-BD2igUkn.js";import{P as de}from"./pencil-BQTOu3Lq.js";import{T as me}from"./trash-2-CFkNW02I.js";import{C as xe}from"./clock-BJLivEWx.js";import{C as pe}from"./circle-check-DW88RjrA.js";import{C as he}from"./circle-x-CUqGH7ad.js";import"./index-B4Vs-Szk.js";import"./proxy-B1EfiGkW.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const N=P("Coins",[["circle",{cx:"8",cy:"8",r:"6",key:"3yglwk"}],["path",{d:"M18.09 10.37A6 6 0 1 1 10.34 18",key:"t5s6rm"}],["path",{d:"M7 6h1v4",key:"1obek4"}],["path",{d:"m16.71 13.88.7.71-2.82 2.82",key:"1rbuyh"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=P("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=P("ShoppingBag",[["path",{d:"M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z",key:"hou9p0"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M16 10a4 4 0 0 1-8 0",key:"1ltviw"}]]),x="w-full bg-navy-light border-2 border-[#2a2a4a] text-cream p-3 rounded font-body text-lg placeholder:text-cream/30 focus:border-gold focus:outline-none transition-colors",H={title:"",description:"",point_cost:50,icon:"",stock:"",auto_approve_threshold:""};function _e(){const{user:n}=ie(),c=(n==null?void 0:n.role)==="parent"||(n==null?void 0:n.role)==="admin",R=(n==null?void 0:n.role)==="kid",[z,K]=a.useState([]),[v,U]=a.useState([]),[Y,W]=a.useState(!0),[E,p]=a.useState(""),[Z,k]=a.useState(!1),[g,C]=a.useState(null),[l,w]=a.useState({...H}),[M,r]=a.useState(""),[A,O]=a.useState(!1),[d,f]=a.useState(null),[$,L]=a.useState(!1),[S,X]=a.useState(null),[h,_]=a.useState(""),[J,b]=a.useState(null),D=(n==null?void 0:n.points_balance)??0,u=a.useCallback(async()=>{try{p("");const t=await i("/api/rewards");K(Array.isArray(t)?t:t.rewards||t.items||[])}catch(t){p(t.message||"The treasure shop is temporarily closed.")}},[]),j=a.useCallback(async()=>{if(c)try{const t=await i("/api/rewards/redemptions?status=pending");U(Array.isArray(t)?t:t.redemptions||t.items||[])}catch{}},[c]);a.useEffect(()=>{Promise.all([u(),j()]).finally(()=>W(!1))},[u,j]);const F=()=>{C(null),w({...H}),r(""),k(!0)},Q=t=>{C(t),w({title:t.title||"",description:t.description||"",point_cost:t.point_cost??t.cost??50,icon:t.icon||"",stock:t.stock!=null?String(t.stock):"",auto_approve_threshold:t.auto_approve_threshold!=null?String(t.auto_approve_threshold):""}),r(""),k(!0)},T=()=>{k(!1),C(null),r("")},m=(t,s)=>{w(o=>({...o,[t]:s}))},ee=async()=>{if(!l.title.trim()){r("Every treasure needs a name!");return}if(Number(l.point_cost)<1){r("The cost must be at least 1 XP.");return}O(!0),r("");const t={title:l.title.trim(),description:l.description.trim(),point_cost:Number(l.point_cost),icon:l.icon||void 0};l.stock!==""&&(t.stock=Number(l.stock)),l.auto_approve_threshold!==""&&(t.auto_approve_threshold=Number(l.auto_approve_threshold));try{g?await i(`/api/rewards/${g.id}`,{method:"PUT",body:t}):await i("/api/rewards",{method:"POST",body:t}),T(),await u()}catch(s){r(s.message||"Could not save the treasure.")}finally{O(!1)}},te=async()=>{if(d){L(!0);try{await i(`/api/rewards/${d.id}`,{method:"DELETE"}),f(null),await u()}catch(t){p(t.message||"Failed to remove the treasure.")}finally{L(!1)}}},se=async t=>{X(t.id),_("");try{await i(`/api/rewards/${t.id}/redeem`,{method:"POST"}),_(`You claimed "${t.title}"! Check your inventory, hero!`),await u()}catch(s){_(s.message||"Redemption failed. The shopkeeper is confused.")}finally{X(null)}},ae=async t=>{b(t.id);try{await i(`/api/rewards/redemptions/${t.id}/approve`,{method:"POST"}),await j()}catch(s){p(s.message||"Could not approve redemption.")}finally{b(null)}},le=async t=>{b(t.id);try{await i(`/api/rewards/redemptions/${t.id}/deny`,{method:"POST"}),await j()}catch(s){p(s.message||"Could not deny redemption.")}finally{b(null)}},ne=t=>D>=(t.point_cost??t.cost??0),oe=t=>t.stock!=null&&t.stock<=0;return Y?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 gap-4",children:[e.jsx(G,{size:48,className:"text-gold animate-pulse"}),e.jsx("p",{className:"text-gold font-heading text-xs animate-pulse",children:"The shopkeeper is arranging the treasures..."})]}):e.jsxs("div",{className:"max-w-5xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(G,{size:28,className:"text-gold"}),e.jsx("h1",{className:"font-heading text-gold text-sm sm:text-base leading-relaxed",children:"Treasure Shop"})]}),c&&e.jsxs("button",{onClick:F,className:"game-btn game-btn-gold flex items-center gap-2",children:[e.jsx(q,{size:16}),"Add Treasure"]})]}),R&&e.jsx("div",{className:"game-panel p-5",children:e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-full bg-gold/20 border-2 border-gold/40 flex items-center justify-center",children:e.jsx(N,{size:28,className:"text-gold"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-cream/50 font-body text-base",children:"Your XP Balance"}),e.jsxs("p",{className:"text-gold font-heading text-lg sm:text-xl",children:[D.toLocaleString()," XP"]})]})]})}),E&&e.jsx("div",{className:"p-3 rounded border-2 border-crimson/40 bg-crimson/10 text-crimson text-base text-center",children:E}),h&&e.jsx("div",{className:`p-3 rounded border-2 text-base text-center ${h.toLowerCase().includes("fail")||h.toLowerCase().includes("confused")||h.toLowerCase().includes("insufficient")?"border-crimson/40 bg-crimson/10 text-crimson":"border-emerald/40 bg-emerald/10 text-emerald"}`,children:h}),z.length===0?e.jsxs("div",{className:"game-panel p-10 text-center",children:[e.jsx(re,{size:48,className:"mx-auto text-cream/20 mb-4"}),e.jsx("p",{className:"text-cream/50 text-xl font-body",children:"The treasure shop is empty. No loot to be found... yet!"}),c&&e.jsxs("button",{onClick:F,className:"game-btn game-btn-gold mt-4 inline-flex items-center gap-2",children:[e.jsx(q,{size:16}),"Stock First Treasure"]})]}):e.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-3",children:z.map(t=>{const s=oe(t),o=ne(t),y=t.point_cost??t.cost??0;return e.jsxs("div",{className:`game-panel p-5 flex flex-col gap-3 relative ${s?"opacity-60":""}`,children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-lg bg-gold/10 border border-gold/20 flex items-center justify-center flex-shrink-0",children:t.icon?e.jsx("span",{className:"text-2xl",children:t.icon}):e.jsx(ce,{size:22,className:"text-gold"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-heading text-cream text-[10px] leading-relaxed",children:t.title}),t.description&&e.jsx("p",{className:"text-cream/50 font-body text-base mt-1 line-clamp-2",children:t.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{size:16,className:"text-gold"}),e.jsxs("span",{className:"text-gold font-heading text-[10px]",children:[y," XP"]})]}),t.stock!=null&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(ue,{size:14,className:s?"text-crimson":"text-cream/40"}),s?e.jsx("span",{className:"text-crimson font-heading text-[9px]",children:"Sold Out"}):e.jsxs("span",{className:"text-cream/50 font-body text-sm",children:[t.stock," left"]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-auto pt-2",children:[R&&e.jsxs("button",{onClick:()=>se(t),disabled:!o||s||S===t.id,className:`game-btn game-btn-gold flex-1 flex items-center justify-center gap-2 ${!o||s?"opacity-40 cursor-not-allowed":""} ${S===t.id?"opacity-60 cursor-wait":""}`,children:[e.jsx(N,{size:14}),S===t.id?"Claiming...":o?s?"Sold Out":"Redeem":"Not Enough XP"]}),c&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>Q(t),className:"p-2 rounded hover:bg-[#2a2a4a] transition-colors text-cream/40 hover:text-sky","aria-label":"Edit reward",children:e.jsx(de,{size:16})}),e.jsx("button",{onClick:()=>f(t),className:"p-2 rounded hover:bg-[#2a2a4a] transition-colors text-cream/40 hover:text-crimson","aria-label":"Delete reward",children:e.jsx(me,{size:16})})]})]})]},t.id)})}),c&&v.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{size:20,className:"text-gold"}),e.jsx("h2",{className:"font-heading text-gold text-xs",children:"Pending Redemptions"}),e.jsx("span",{className:"ml-auto bg-gold/20 text-gold font-heading text-[9px] px-2 py-1 rounded-full",children:v.length})]}),e.jsx("div",{className:"space-y-3",children:v.map(t=>{var o,y,I,B;const s=J===t.id;return e.jsxs("div",{className:"game-panel p-4 flex flex-col sm:flex-row items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-cream font-heading text-[10px] leading-relaxed",children:t.reward_title||((o=t.reward)==null?void 0:o.title)||"Reward"}),e.jsxs("div",{className:"flex items-center gap-3 mt-1 flex-wrap",children:[e.jsxs("span",{className:"text-cream/50 font-body text-base",children:["Requested by"," ",e.jsx("span",{className:"text-sky",children:t.kid_name||((y=t.user)==null?void 0:y.display_name)||((I=t.user)==null?void 0:I.username)||"Hero"})]}),e.jsxs("span",{className:"flex items-center gap-1 text-gold text-sm",children:[e.jsx(N,{size:12}),t.points_spent||t.points||((B=t.reward)==null?void 0:B.point_cost)||0," XP"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsxs("button",{onClick:()=>ae(t),disabled:s,className:`game-btn game-btn-gold flex items-center gap-1 ${s?"opacity-60 cursor-wait":""}`,children:[e.jsx(pe,{size:14}),"Approve"]}),e.jsxs("button",{onClick:()=>le(t),disabled:s,className:`game-btn game-btn-red flex items-center gap-1 ${s?"opacity-60 cursor-wait":""}`,children:[e.jsx(he,{size:14}),"Deny"]})]})]},t.id)})})]}),e.jsx(V,{isOpen:Z,onClose:T,title:g?"Edit Treasure":"New Treasure",actions:[{label:"Cancel",onClick:T,className:"game-btn game-btn-blue"},{label:A?"Saving...":g?"Update Treasure":"Add Treasure",onClick:ee,className:"game-btn game-btn-gold",disabled:A}],children:e.jsxs("div",{className:"space-y-4",children:[M&&e.jsx("div",{className:"p-2 rounded border border-crimson/40 bg-crimson/10 text-crimson text-base",children:M}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gold/80 text-sm font-heading mb-1 tracking-wide",children:"Treasure Name"}),e.jsx("input",{type:"text",value:l.title,onChange:t=>m("title",t.target.value),placeholder:"Extra Screen Time",className:x})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gold/80 text-sm font-heading mb-1 tracking-wide",children:"Description"}),e.jsx("textarea",{value:l.description,onChange:t=>m("description",t.target.value),placeholder:"What does this treasure grant?",rows:3,className:`${x} resize-none`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gold/80 text-sm font-heading mb-1 tracking-wide",children:"Cost (XP)"}),e.jsx("input",{type:"number",min:1,value:l.point_cost,onChange:t=>m("point_cost",t.target.value),className:x})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gold/80 text-sm font-heading mb-1 tracking-wide",children:"Icon (Emoji)"}),e.jsx("input",{type:"text",value:l.icon,onChange:t=>m("icon",t.target.value),placeholder:"e.g. trophy, star, gift",className:x})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gold/80 text-sm font-heading mb-1 tracking-wide",children:"Stock (Optional)"}),e.jsx("input",{type:"number",min:0,value:l.stock,onChange:t=>m("stock",t.target.value),placeholder:"Leave empty for unlimited",className:x}),e.jsx("p",{className:"text-cream/30 font-body text-sm mt-1",children:"Leave empty for unlimited supply."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gold/80 text-sm font-heading mb-1 tracking-wide",children:"Auto-Approve Threshold (Optional)"}),e.jsx("input",{type:"number",min:0,value:l.auto_approve_threshold,onChange:t=>m("auto_approve_threshold",t.target.value),placeholder:"Max cost to auto-approve",className:x}),e.jsx("p",{className:"text-cream/30 font-body text-sm mt-1",children:"Redemptions at or below this cost are auto-approved."})]})]})}),e.jsx(V,{isOpen:!!d,onClose:()=>f(null),title:"Remove Treasure?",actions:[{label:"Keep Treasure",onClick:()=>f(null),className:"game-btn game-btn-blue"},{label:$?"Removing...":"Remove Treasure",onClick:te,className:"game-btn game-btn-red",disabled:$}],children:e.jsxs("p",{className:"text-cream/70",children:["Are you sure you want to remove"," ",e.jsxs("span",{className:"text-gold font-heading text-[10px]",children:['"',d==null?void 0:d.title,'"']})," ","from the treasure shop? Heroes can no longer redeem this reward."]})})]})}export{_e as default};
