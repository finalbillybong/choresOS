import{a as je,u as Ne,c as ve,r as a,b as y,j as e,C as ne,d as q,X as Se,h as ie}from"./index-DNZbfclw.js";import{t as L}from"./questThemeText-DkmuO04F.js";import{M as le}from"./Modal-9JikIi0L.js";import{C as we}from"./chevron-left-B915NE6Z.js";import{C as Ce}from"./chevron-right-DRz-yEG_.js";import{T as ke}from"./trash-2-iVzWod5p.js";import{A as Te,S as De}from"./slash-xhRB3waA.js";import{C as ce}from"./clock-GwqV94wP.js";import"./index-DNx_QacM.js";import"./proxy-CTpQfhFp.js";function K(d){return d.toISOString().slice(0,10)}function o(d,l){const m=new Date(d+"T00:00:00");return m.setDate(m.getDate()+l),m.toISOString().slice(0,10)}const _e=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function ze(d,l){const m=new Date().toISOString().slice(0,10);return d.status==="verified"?{border:"border-emerald",bg:"bg-emerald/10",icon:e.jsx(ie,{size:16,className:"text-emerald"})}:d.status==="completed"?{border:"border-emerald",bg:"bg-emerald/5",icon:e.jsx(ie,{size:16,className:"text-emerald/60"})}:d.status==="skipped"?{border:"border-border",bg:"bg-navy-light/50",icon:e.jsx(De,{size:16,className:"text-muted"}),textClass:"line-through text-muted"}:l<m?{border:"border-crimson",bg:"bg-crimson/5",icon:e.jsx(ce,{size:16,className:"text-crimson"})}:{border:"border-border",bg:"",icon:e.jsx(ce,{size:16,className:"text-muted"})}}function Fe(){var te,se,ae;const d=je(),{user:l}=Ne(),{colorTheme:m}=ve(),j=(l==null?void 0:l.role)==="kid",[i,O]=a.useState(()=>K(new Date)),[M,oe]=a.useState({}),[R,P]=a.useState(!0),[E,v]=a.useState(""),[de,S]=a.useState(!1),[h,me]=a.useState(null),[F,I]=a.useState([]),[w,Q]=a.useState(""),[W,H]=a.useState(!1),[J,C]=a.useState(""),[U,X]=a.useState(null),[r,k]=a.useState(null),[Y,B]=a.useState(!1),[G,V]=a.useState(""),b=a.useCallback(async()=>{var t,u,n;P(!0),v("");try{const T=new Date(i+"T00:00:00").getDay(),A=T===0?-6:1-T,g=o(i,A),D=await y(`/api/calendar?week_start=${g}`),s={};for(let x=0;x<7;x++){const c=o(i,x);s[c]=((t=D.days)==null?void 0:t[c])||[]}const f=o(g,7),_=o(i,6),z=o(g,6);if(_>z)try{const x=await y(`/api/calendar?week_start=${f}`);for(let c=0;c<7;c++){const N=o(i,c);!((u=s[N])!=null&&u.length)&&((n=x.days)!=null&&n[N])&&(s[N]=x.days[N])}}catch{}oe(s)}catch(p){v(p.message||"Failed to load calendar")}finally{P(!1)}},[i]);a.useEffect(()=>{b()},[b]),a.useEffect(()=>{const t=()=>{b()};return window.addEventListener("ws:message",t),()=>window.removeEventListener("ws:message",t)},[b]);const xe=()=>O(o(i,-7)),ue=()=>O(o(i,7)),he=()=>O(K(new Date)),be=async t=>{me(t),C(""),Q(""),S(!0);try{const n=(await y("/api/stats/kids")||[]).filter(p=>p.id!==l.id);I(n)}catch{I([])}},pe=async()=>{if(!w){C("Select a hero to trade with");return}H(!0),C("");try{await y("/api/calendar/trade",{method:"POST",body:{assignment_id:h.id,target_user_id:w}}),S(!1),b()}catch(t){C(t.message||"Trade failed")}finally{H(!1)}},$=async(t,u=!1)=>{X(t),k(null);try{await y(`/api/calendar/assignments/${t}${u?"?all_future=true":""}`,{method:"DELETE"}),b()}catch(n){v(n.message||"Failed to remove quest")}finally{X(null)}},ge=async()=>{B(!0),V("");try{const t=await y("/api/chores/cleanup-all-stale",{method:"POST"});V(t.message||"Cleanup complete"),b()}catch(t){v(t.message||"Cleanup failed")}finally{B(!1)}},fe=o(i,6),Z=K(new Date),ye=i===Z,ee=t=>new Date(t+"T00:00:00").toLocaleDateString(void 0,{month:"short",day:"numeric"});return e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ne,{size:28,className:"text-sky"}),e.jsx("h1",{className:"text-cream text-xl font-extrabold leading-relaxed",children:"Quest Calendar"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:xe,className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-cream","aria-label":"Previous week",children:e.jsx(we,{size:20})}),e.jsxs("span",{className:"text-cream text-sm min-w-[140px] sm:min-w-[180px] text-center",children:[ee(i)," â€“ ",ee(fe)]}),e.jsx("button",{onClick:ue,className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-cream","aria-label":"Next 7 days",children:e.jsx(Ce,{size:20})})]}),!ye&&e.jsx("button",{onClick:he,className:"game-btn game-btn-blue",children:"Today"}),!j&&e.jsxs("button",{onClick:ge,disabled:Y,className:"game-btn game-btn-red flex items-center gap-1",title:"Remove all overdue pending quests and reset exclusions",children:[Y?e.jsx(q,{size:14,className:"animate-spin"}):e.jsx(ke,{size:14}),"Clean Up"]})]})]}),G&&e.jsx("div",{className:"mb-4 p-3 rounded border-2 border-emerald/40 bg-emerald/10 text-emerald text-sm text-center",children:G}),E&&e.jsx("div",{className:"mb-4 p-3 rounded border-2 border-crimson/40 bg-crimson/10 text-crimson text-sm text-center",children:E}),R&&e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx(q,{size:32,className:"text-sky animate-spin"})}),!R&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-7 gap-3",children:Array.from({length:7},(t,u)=>{const n=o(i,u),p=new Date(n+"T00:00:00"),T=_e[p.getDay()],A=n===Z,g=M[n]||[],D=j?g.filter(s=>s.user_id===(l==null?void 0:l.id)):g;return e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:`text-center py-2 px-1 rounded-t-md border-b-2 ${A?"bg-sky/10 border-sky text-sky":"bg-surface-raised/30 border-border text-muted"}`,children:[e.jsx("div",{className:"text-xs font-bold tracking-wider",children:T}),e.jsx("div",{className:"text-sm mt-1",children:new Date(n+"T00:00:00").getDate()})]}),e.jsxs("div",{className:"space-y-2 mt-2 min-h-[80px]",children:[D.length===0&&e.jsx("p",{className:"text-muted text-xs text-center py-4",children:"No quests"}),D.map(s=>{var _,z,x;const f=ze(s,n);return e.jsxs("div",{className:`game-panel !border-2 ${f.border} ${f.bg} p-2 cursor-pointer hover:brightness-110 transition-all`,onClick:()=>d(`/chores/${s.chore_id||s.id}`),children:[e.jsxs("div",{className:"flex items-start gap-1.5",children:[f.icon,e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:`text-sm leading-tight truncate ${f.textClass||"text-cream"}`,children:L(((_=s.chore)==null?void 0:_.title)||s.chore_title||"Quest",m)}),!j&&(((z=s.user)==null?void 0:z.display_name)||s.assigned_to_name)&&e.jsx("p",{className:"text-xs text-purple font-medium mt-0.5 truncate",children:((x=s.user)==null?void 0:x.display_name)||s.assigned_to_name})]})]}),j&&s.status==="pending"&&e.jsxs("button",{onClick:c=>{c.stopPropagation(),be(s)},className:"mt-1.5 flex items-center gap-1 text-xs font-medium text-sky hover:text-sky/80 transition-colors",children:[e.jsx(Te,{size:12}),"Trade"]}),!j&&s.status==="pending"&&e.jsxs("button",{onClick:c=>{var re;c.stopPropagation(),((re=s.chore)==null?void 0:re.recurrence)&&s.chore.recurrence!=="once"?k(s):$(s.id)},disabled:U===s.id,className:"mt-1.5 flex items-center gap-1 text-xs font-medium text-crimson hover:text-crimson/80 transition-colors",children:[U===s.id?e.jsx(q,{size:12,className:"animate-spin"}):e.jsx(Se,{size:12}),"Remove"]})]},s.id)})]})]},n)})}),!R&&!E&&Object.values(M).every(t=>t.length===0)&&e.jsxs("div",{className:"text-center py-16",children:[e.jsx(ne,{size:48,className:"text-muted mx-auto mb-4"}),e.jsx("p",{className:"text-cream text-lg font-bold",children:"No quests scheduled this week"}),e.jsx("p",{className:"text-muted text-sm mt-2",children:"The quest board is empty. Time to plan new adventures!"})]}),e.jsx(le,{isOpen:de,onClose:()=>S(!1),title:"Propose a Trade",actions:[{label:"Cancel",onClick:()=>S(!1),className:"game-btn game-btn-red"},{label:W?"Sending...":"Send Trade",onClick:pe,className:"game-btn game-btn-blue",disabled:W||!w}],children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-muted text-sm",children:["Trade"," ",e.jsx("span",{className:"text-cream font-bold",children:L(((te=h==null?void 0:h.chore)==null?void 0:te.title)||(h==null?void 0:h.chore_title)||"Quest",m)})," ","with another hero:"]}),J&&e.jsx("div",{className:"p-2 rounded border border-crimson/40 bg-crimson/10 text-crimson text-sm",children:J}),F.length===0?e.jsx("p",{className:"text-muted text-sm",children:"No other heroes found in your party."}):e.jsx("div",{className:"space-y-2",children:F.map(t=>e.jsx("button",{onClick:()=>Q(t.id),className:`w-full text-left p-3 rounded border-2 transition-colors ${w===t.id?"border-sky bg-sky/10 text-sky":"border-border text-muted hover:border-cream/30"}`,children:e.jsx("span",{className:"text-sm",children:t.display_name||t.username})},t.id))})]})}),e.jsx(le,{isOpen:!!r,onClose:()=>k(null),title:"Remove Recurring Quest",actions:[{label:"Cancel",onClick:()=>k(null),className:"game-btn game-btn-blue"},{label:"Just This One",onClick:()=>$(r==null?void 0:r.id,!1),className:"game-btn game-btn-red"},{label:"All Future",onClick:()=>$(r==null?void 0:r.id,!0),className:"game-btn game-btn-red"}],children:e.jsxs("p",{className:"text-muted text-sm",children:[e.jsx("span",{className:"text-cream font-bold",children:L(((se=r==null?void 0:r.chore)==null?void 0:se.title)||"Quest",m)})," ","is a recurring quest",(ae=r==null?void 0:r.user)!=null&&ae.display_name?` for ${r.user.display_name}`:"",". Remove just this one instance, or all future pending instances for this kid?"]})})]})}export{Fe as default};
