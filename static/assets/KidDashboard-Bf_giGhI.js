import{r,j as e,b as k,u as Y,C as Z}from"./index-_mTouwGG.js";import{S as G}from"./star-NY0cNry0.js";import{m as C}from"./proxy-ot5MUewZ.js";import{F as B}from"./flame-BMwR7tbg.js";import{A as U}from"./index-Bh2TBjIQ.js";import{L as V}from"./loader-circle-Pyy6N8rf.js";import{T as J}from"./triangle-alert-H3n-ws9Y.js";import{S as ee}from"./sword-C3Ux7FGr.js";import{C as te}from"./camera-BmvNStLQ.js";import{C as se}from"./circle-check-Z0twjO-L.js";function ae({value:t=0,prefix:o="XP"}){const[n,i]=r.useState(t),s=r.useRef(t),d=r.useRef(null);return r.useEffect(()=>{const f=s.current,p=t;if(s.current=t,f===p){i(p);return}const w=p-f,M=Math.min(Math.abs(w)*15,1500),S=performance.now();function b(z){const h=z-S,g=Math.min(h/M,1),j=1-Math.pow(1-g,3),c=Math.round(f+w*j);i(c),g<1&&(d.current=requestAnimationFrame(b))}return d.current=requestAnimationFrame(b),()=>{d.current&&cancelAnimationFrame(d.current)}},[t]),e.jsxs("div",{className:"inline-flex items-center gap-1.5",children:[e.jsx(G,{size:16,className:"text-gold fill-gold"}),e.jsxs("span",{className:"font-heading text-gold text-sm font-bold tabular-nums",children:[n.toLocaleString()," ",o]})]})}const ne={scale:[1,1.1,.97,1.05,1],rotate:[-1,2,-2,1,0],transition:{duration:1,repeat:1/0,repeatType:"mirror",ease:"easeInOut"}};function re(t){return t>=30?{size:28,className:"text-orange-400 drop-shadow-[0_0_8px_rgba(251,146,60,0.5)]"}:t>=7?{size:22,className:"text-orange-400"}:{size:18,className:"text-orange-400/70"}}function oe({streak:t=0,longest:o=0}){const[n,i]=r.useState(!1),s=re(t),d=t>=30;return e.jsxs("div",{className:"relative inline-flex items-center gap-1",onMouseEnter:()=>i(!0),onMouseLeave:()=>i(!1),children:[d?e.jsx(C.div,{animate:ne,className:"flex items-center",children:e.jsx(B,{size:s.size,className:s.className})}):e.jsx(B,{size:s.size,className:s.className}),e.jsx("span",{className:"font-bold text-orange-400 text-sm tabular-nums",children:t}),n&&e.jsxs("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-1.5 bg-surface-raised border border-border rounded-lg text-center whitespace-nowrap z-10 shadow-lg",children:[e.jsxs("p",{className:"text-cream text-xs font-medium",children:[t," day streak"]}),e.jsxs("p",{className:"text-muted text-[10px]",children:["Best: ",o]}),e.jsx("div",{className:"absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-[5px] border-l-transparent border-r-[5px] border-r-transparent border-t-[5px] border-t-border"})]})]})}const W=["#3b82f6","#10b981","#f59e0b","#a855f7","#ef4444","#60a5fa"],ie=30,L=3;function F(t,o){return Math.random()*(o-t)+t}function le(){return Array.from({length:ie},(t,o)=>{const n=F(0,Math.PI*2),i=F(200,500),s=F(6,14),d=Math.random()>.5?"circle":"rect";return{id:o,color:W[Math.floor(Math.random()*W.length)],x:Math.cos(n)*i,y:Math.sin(n)*i,rotation:F(0,720),size:s,shape:d}})}function X({onComplete:t}){const[o,n]=r.useState(!0),i=r.useMemo(()=>le(),[]);return r.useEffect(()=>{const s=setTimeout(()=>{n(!1),t==null||t()},L*1e3);return()=>clearTimeout(s)},[t]),e.jsx(U,{children:o&&e.jsx("div",{className:"fixed inset-0 z-[100] pointer-events-none overflow-hidden",children:i.map(s=>e.jsx(C.div,{className:"absolute",style:{left:"50%",top:"40%",width:s.shape==="circle"?s.size:s.size*.7,height:s.size,backgroundColor:s.color,borderRadius:s.shape==="circle"?"50%":"2px"},initial:{x:0,y:0,opacity:1,rotate:0,scale:1},animate:{x:s.x,y:[0,s.y*.4,s.y+300],opacity:[1,1,0],rotate:s.rotation,scale:[1,1.2,.5]},transition:{duration:L,ease:[.25,.46,.45,.94],y:{duration:L,ease:[.22,.61,.36,1]}}},s.id))})})}const D=[{value:1,color:"#ef4444"},{value:5,color:"#f59e0b"},{value:2,color:"#10b981"},{value:10,color:"#a855f7"},{value:3,color:"#3b82f6"},{value:15,color:"#f97316"},{value:1,color:"#ec4899"},{value:25,color:"#f59e0b"},{value:2,color:"#06b6d4"},{value:5,color:"#10b981"},{value:3,color:"#a855f7"},{value:10,color:"#ef4444"}],T=360/D.length;function O(t,o,n,i){const s=(i-90)*Math.PI/180;return{x:t+n*Math.cos(s),y:o+n*Math.sin(s)}}function ce(t,o,n,i,s){const d=O(t,o,n,s),f=O(t,o,n,i),p=s-i<=180?"0":"1";return["M",t,o,"L",d.x,d.y,"A",n,n,0,p,0,f.x,f.y,"Z"].join(" ")}function de({onResult:t,disabled:o=!1}){const[n,i]=r.useState(!1),[s,d]=r.useState(0),[f,p]=r.useState(null),[w,M]=r.useState(!1),[S,b]=r.useState(null);r.useRef(!1);const z=r.useCallback(async()=>{if(!(n||o)){i(!0),p(null),b(null);try{const c=await k("/api/spin/spin",{method:"POST"}),y=c.points||c.result||5;let m=D.findIndex(E=>E.value===y);m===-1&&(m=Math.floor(Math.random()*D.length));const A=m*T+T/2,P=5+Math.floor(Math.random()*3),N=s+P*360+(360-A);d(N),setTimeout(()=>{p(y),M(!0),i(!1),t==null||t(y)},3500)}catch(c){b(c.message||"Spin failed!"),i(!1)}}},[n,o,s,t]),h=150,g=150,j=140;return e.jsxs("div",{className:"flex flex-col items-center gap-5",children:[w&&e.jsx(X,{onComplete:()=>M(!1)}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1 z-10",children:e.jsx("div",{className:"w-0 h-0 border-l-[12px] border-l-transparent border-r-[12px] border-r-transparent border-t-[20px] border-t-sky",style:{filter:"drop-shadow(0 2px 6px rgba(59,130,246,0.4))"}})}),e.jsx(C.div,{animate:{rotate:s},transition:{duration:3.5,ease:[.2,.8,.3,1]},className:"w-[300px] h-[300px]",children:e.jsxs("svg",{width:"300",height:"300",viewBox:"0 0 300 300",className:"drop-shadow-xl",children:[e.jsx("circle",{cx:h,cy:g,r:j+4,fill:"none",stroke:"#1e293b",strokeWidth:"4"}),D.map((c,y)=>{const m=y*T,A=m+T,P=m+T/2,N=O(h,g,j*.65,P);return e.jsxs("g",{children:[e.jsx("path",{d:ce(h,g,j,m,A),fill:c.color,stroke:"#0a0e1a",strokeWidth:"2",opacity:.9}),e.jsx("text",{x:N.x,y:N.y,textAnchor:"middle",dominantBaseline:"central",fill:"white",fontFamily:"Inter, system-ui, sans-serif",fontSize:"12",fontWeight:"800",transform:`rotate(${P}, ${N.x}, ${N.y})`,children:c.value})]},y)}),e.jsx("circle",{cx:h,cy:g,r:22,fill:"#111827",stroke:"#1e293b",strokeWidth:"3"}),e.jsx("circle",{cx:h,cy:g,r:10,fill:"#3b82f6"})]})})]}),f!==null&&e.jsxs("div",{className:"game-panel px-6 py-3 text-center",children:[e.jsx("p",{className:"text-muted text-xs",children:"You won"}),e.jsxs("p",{className:"text-gold text-lg font-bold mt-1",children:[f," XP"]})]}),S&&e.jsx("p",{className:"text-crimson text-sm text-center",children:S}),e.jsx("button",{onClick:z,disabled:n||o,className:`game-btn game-btn-blue text-base px-10 py-3 ${n||o?"opacity-50 cursor-not-allowed":""}`,children:n?"SPINNING...":"SPIN!"})]})}function me(){const t=new Date,o=t.getDay(),n=o===0?-6:1-o,i=new Date(t);return i.setDate(t.getDate()+n),i.toISOString().slice(0,10)}function xe(){return new Date().toISOString().slice(0,10)}function ue(t){switch(t){case"easy":return{text:"Easy",color:"text-emerald bg-emerald/10 border-emerald/20"};case"medium":return{text:"Medium",color:"text-gold bg-gold/10 border-gold/20"};case"hard":return{text:"Hard",color:"text-orange-400 bg-orange-400/10 border-orange-400/20"};case"expert":return{text:"Expert",color:"text-crimson bg-crimson/10 border-crimson/20"};default:return{text:"Easy",color:"text-emerald bg-emerald/10 border-emerald/20"}}}const fe={hidden:{opacity:0,y:12},visible:t=>({opacity:1,y:0,transition:{delay:t*.05,type:"spring",stiffness:300,damping:28}})},pe={idle:{scale:1},tap:{scale:.96}};function Me(){const{user:t,updateUser:o}=Y(),[n,i]=r.useState([]),[s,d]=r.useState([]),[f,p]=r.useState(null),[w,M]=r.useState(!0),[S,b]=r.useState(null),[z,h]=r.useState(null),[g,j]=r.useState(!1),[c,y]=r.useState({}),m=r.useCallback(async()=>{try{b(null);const l=me(),x=xe(),[a,u,v]=await Promise.all([k("/api/chores"),k(`/api/calendar?week_start=${l}`),k("/api/spin/availability")]);d(a);const _=u.days&&u.days[x]||[];i(_),p(v)}catch(l){b(l.message||"Failed to load quest data")}finally{M(!1)}},[]);r.useEffect(()=>{m()},[m]),r.useEffect(()=>{const l=()=>{m()};return window.addEventListener("ws:message",l),()=>window.removeEventListener("ws:message",l)},[m]);const A=async l=>{const x=l.chore_id,a=l.chore;if(!(a!=null&&a.requires_photo&&!c[x])){h(x);try{if(a!=null&&a.requires_photo&&c[x]){const u=new FormData;u.append("file",c[x]),await k(`/api/chores/${x}/complete`,{method:"POST",body:u})}else await k(`/api/chores/${x}/complete`,{method:"POST"});j(!0),a!=null&&a.points&&t&&o({points_balance:t.points_balance+a.points}),y(u=>{const v={...u};return delete v[x],v}),await m()}catch(u){b(u.message||"Failed to complete quest")}finally{h(null)}}},P=(l,x)=>{y(a=>({...a,[l]:x}))};function N(l){return l==="verified"?e.jsxs("span",{className:"inline-flex items-center gap-1 text-emerald text-xs font-medium bg-emerald/10 px-2 py-0.5 rounded-full",children:[e.jsx(Z,{size:12})," Verified"]}):l==="completed"?e.jsxs("span",{className:"inline-flex items-center gap-1 text-gold text-xs font-medium bg-gold/10 px-2 py-0.5 rounded-full",children:[e.jsx(se,{size:12})," Pending"]}):null}if(w)return e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsx(V,{className:"animate-spin text-sky",size:28})});const E=n.filter(l=>l.status==="verified"||l.status==="completed").length,I=n.length,Q=I>0?Math.round(E/I*100):0;return e.jsxs("div",{className:"max-w-2xl mx-auto space-y-5",children:[e.jsx(U,{children:g&&e.jsx(X,{onComplete:()=>j(!1)})}),e.jsxs("div",{className:"game-panel p-5",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 flex-wrap mb-4",children:[e.jsx("h1",{className:"font-heading text-cream text-xl font-extrabold",children:"Quest Board"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ae,{value:(t==null?void 0:t.points_balance)??0}),e.jsx(oe,{streak:(t==null?void 0:t.current_streak)??0})]})]}),I>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[e.jsx("span",{className:"text-muted text-xs font-medium",children:"Today's Progress"}),e.jsxs("span",{className:"text-cream text-xs font-bold",children:[E,"/",I]})]}),e.jsx("div",{className:"xp-bar",children:e.jsx(C.div,{className:"xp-bar-fill",initial:{width:0},animate:{width:`${Q}%`},transition:{duration:.8,ease:[.22,1,.36,1]}})})]})]}),S&&e.jsxs("div",{className:"game-panel p-3 flex items-center gap-2 border-crimson/30 text-crimson text-sm",children:[e.jsx(J,{size:16}),e.jsx("span",{children:S})]}),n.length===0&&!w?e.jsxs(C.div,{className:"game-panel p-10 flex flex-col items-center gap-3 text-center",initial:{opacity:0,y:12},animate:{opacity:1,y:0},children:[e.jsx(ee,{size:36,className:"text-muted"}),e.jsx("p",{className:"text-muted text-sm",children:"No quests for today. Take a break!"})]}):e.jsx("div",{className:"space-y-3",children:n.map((l,x)=>{var $,q;const a=l.chore;if(!a)return null;const u=l.status==="pending",v=z===a.id,_=ue(a.difficulty),H=(($=a.category)==null?void 0:$.colour)||"#3b82f6";return e.jsx(C.div,{className:"game-panel p-4 transition-all",variants:fe,initial:"hidden",animate:"visible",custom:x,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"mt-0.5 w-1 h-12 rounded-full flex-shrink-0",style:{backgroundColor:H}}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1.5",children:[e.jsx("h3",{className:"text-cream text-sm font-semibold truncate",children:a.title}),N(l.status)]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"inline-flex items-center gap-1 text-gold text-xs font-semibold",children:[e.jsx(G,{size:12,fill:"currentColor"}),a.points," XP"]}),e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold border ${_.color}`,children:_.text}),((q=a.category)==null?void 0:q.name)&&e.jsx("span",{className:"text-muted text-xs",children:a.category.name})]}),a.requires_photo&&u&&e.jsx("div",{className:"mt-2",children:e.jsxs("label",{className:"inline-flex items-center gap-1.5 text-xs text-muted cursor-pointer hover:text-cream transition-colors bg-surface-raised px-3 py-1.5 rounded-lg border border-border",children:[e.jsx(te,{size:14}),e.jsx("span",{children:c[a.id]?c[a.id].name:"Attach proof photo"}),e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:K=>{var R;return P(a.id,((R=K.target.files)==null?void 0:R[0])||null)}})]})}),u&&e.jsx(C.button,{className:`game-btn game-btn-blue mt-3 w-full sm:w-auto ${v?"opacity-60 cursor-wait":""} ${a.requires_photo&&!c[a.id]?"opacity-40 cursor-not-allowed":""}`,variants:pe,whileTap:"tap",disabled:v||a.requires_photo&&!c[a.id],onClick:()=>A(l),children:v?e.jsxs("span",{className:"flex items-center gap-2 justify-center",children:[e.jsx(V,{size:14,className:"animate-spin"}),"Completing..."]}):"Complete Quest"})]})]})},l.id)})}),e.jsx("div",{className:"pt-2",children:e.jsx(de,{availability:f,onSpinComplete:()=>{m()}})})]})}export{Me as default};
