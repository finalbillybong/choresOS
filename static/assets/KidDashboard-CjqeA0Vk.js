import{r as o,j as e,b as E,u as Y,C as Z}from"./index-BII3YuF0.js";import{S as U}from"./star-mXyNyUyA.js";import{m as P}from"./proxy-JrWQbB92.js";import{F as V}from"./flame-D_GhdZOD.js";import{A as X}from"./index-D59XlZBZ.js";import{L as W}from"./loader-circle-XE8sOnEV.js";import{T as J}from"./triangle-alert-DAEBSzEG.js";import{S as ee}from"./sword-BfzfY54Z.js";import{C as te}from"./camera-DVRfLPEW.js";import{C as se}from"./circle-check-BDSAM32P.js";function ae({value:t=0,prefix:i="XP"}){const[a,l]=o.useState(t),s=o.useRef(t),c=o.useRef(null);return o.useEffect(()=>{const f=s.current,h=t;if(s.current=t,f===h){l(h);return}const S=h-f,k=Math.min(Math.abs(S)*15,1500),C=performance.now();function j(T){const z=T-C,M=Math.min(z/k,1),m=1-Math.pow(1-M,3),p=Math.round(f+S*m);l(p),M<1&&(c.current=requestAnimationFrame(j))}return c.current=requestAnimationFrame(j),()=>{c.current&&cancelAnimationFrame(c.current)}},[t]),e.jsxs("div",{className:"inline-flex items-center gap-1.5",children:[e.jsx(U,{size:16,className:"text-gold fill-gold"}),e.jsxs("span",{className:"font-heading text-gold text-sm font-bold tabular-nums",children:[a.toLocaleString()," ",i]})]})}const ne={scale:[1,1.1,.97,1.05,1],rotate:[-1,2,-2,1,0],transition:{duration:1,repeat:1/0,repeatType:"mirror",ease:"easeInOut"}};function re(t){return t>=30?{size:28,className:"text-orange-400 drop-shadow-[0_0_8px_rgba(251,146,60,0.5)]"}:t>=7?{size:22,className:"text-orange-400"}:{size:18,className:"text-orange-400/70"}}function oe({streak:t=0,longest:i=0}){const[a,l]=o.useState(!1),s=re(t),c=t>=30;return e.jsxs("div",{className:"relative inline-flex items-center gap-1",onMouseEnter:()=>l(!0),onMouseLeave:()=>l(!1),children:[c?e.jsx(P.div,{animate:ne,className:"flex items-center",children:e.jsx(V,{size:s.size,className:s.className})}):e.jsx(V,{size:s.size,className:s.className}),e.jsx("span",{className:"font-bold text-orange-400 text-sm tabular-nums",children:t}),a&&e.jsxs("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-1.5 bg-surface-raised border border-border rounded-lg text-center whitespace-nowrap z-10 shadow-lg",children:[e.jsxs("p",{className:"text-cream text-xs font-medium",children:[t," day streak"]}),e.jsxs("p",{className:"text-muted text-[10px]",children:["Best: ",i]}),e.jsx("div",{className:"absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-[5px] border-l-transparent border-r-[5px] border-r-transparent border-t-[5px] border-t-border"})]})]})}const G=["#3b82f6","#10b981","#f59e0b","#a855f7","#ef4444","#60a5fa"],ie=30,L=3;function D(t,i){return Math.random()*(i-t)+t}function le(){return Array.from({length:ie},(t,i)=>{const a=D(0,Math.PI*2),l=D(200,500),s=D(6,14),c=Math.random()>.5?"circle":"rect";return{id:i,color:G[Math.floor(Math.random()*G.length)],x:Math.cos(a)*l,y:Math.sin(a)*l,rotation:D(0,720),size:s,shape:c}})}function K({onComplete:t}){const[i,a]=o.useState(!0),l=o.useMemo(()=>le(),[]);return o.useEffect(()=>{const s=setTimeout(()=>{a(!1),t==null||t()},L*1e3);return()=>clearTimeout(s)},[t]),e.jsx(X,{children:i&&e.jsx("div",{className:"fixed inset-0 z-[100] pointer-events-none overflow-hidden",children:l.map(s=>e.jsx(P.div,{className:"absolute",style:{left:"50%",top:"40%",width:s.shape==="circle"?s.size:s.size*.7,height:s.size,backgroundColor:s.color,borderRadius:s.shape==="circle"?"50%":"2px"},initial:{x:0,y:0,opacity:1,rotate:0,scale:1},animate:{x:s.x,y:[0,s.y*.4,s.y+300],opacity:[1,1,0],rotate:s.rotation,scale:[1,1.2,.5]},transition:{duration:L,ease:[.25,.46,.45,.94],y:{duration:L,ease:[.22,.61,.36,1]}}},s.id))})})}const F=[{value:1,color:"#ef4444"},{value:5,color:"#f59e0b"},{value:2,color:"#10b981"},{value:10,color:"#a855f7"},{value:3,color:"#3b82f6"},{value:15,color:"#f97316"},{value:1,color:"#ec4899"},{value:25,color:"#f59e0b"},{value:2,color:"#06b6d4"},{value:5,color:"#10b981"},{value:3,color:"#a855f7"},{value:10,color:"#ef4444"}],I=360/F.length;function O(t,i,a,l){const s=(l-90)*Math.PI/180;return{x:t+a*Math.cos(s),y:i+a*Math.sin(s)}}function ce(t,i,a,l,s){const c=O(t,i,a,s),f=O(t,i,a,l),h=s-l<=180?"0":"1";return["M",t,i,"L",c.x,c.y,"A",a,a,0,h,0,f.x,f.y,"Z"].join(" ")}function de({availability:t,onSpinComplete:i}){const[a,l]=o.useState(!1),[s,c]=o.useState(0),[f,h]=o.useState(null),[S,k]=o.useState(!1),[C,j]=o.useState(null),T=o.useRef(!1),z=(t==null?void 0:t.can_spin)??!0,M=(t==null?void 0:t.reason)??null,m=!z,p=o.useCallback(async()=>{if(!(a||m)){l(!0),h(null),j(null);try{const g=await E("/api/spin/spin",{method:"POST"}),N=g.points_won??g.points??g.result??5;let b=F.findIndex(d=>d.value===N);b===-1&&(b=Math.floor(Math.random()*F.length));const w=b*I+I/2,A=5+Math.floor(Math.random()*3),r=s+A*360+(360-w);c(r),setTimeout(()=>{h(N),k(!0),l(!1),T.current=!0,i==null||i(N)},3500)}catch(g){j(g.message||"Spin failed!"),l(!1)}}},[a,m,s,i]),y=150,x=150,_=140;return e.jsxs("div",{className:"flex flex-col items-center gap-5",children:[S&&e.jsx(K,{onComplete:()=>k(!1)}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1 z-10",children:e.jsx("div",{className:"w-0 h-0 border-l-[12px] border-l-transparent border-r-[12px] border-r-transparent border-t-[20px] border-t-sky",style:{filter:"drop-shadow(0 2px 6px rgba(59,130,246,0.4))"}})}),e.jsx(P.div,{animate:{rotate:s},transition:{duration:3.5,ease:[.2,.8,.3,1]},className:"w-[300px] h-[300px]",children:e.jsxs("svg",{width:"300",height:"300",viewBox:"0 0 300 300",className:"drop-shadow-xl",children:[e.jsx("circle",{cx:y,cy:x,r:_+4,fill:"none",stroke:"#1e293b",strokeWidth:"4"}),F.map((g,N)=>{const b=N*I,w=b+I,A=b+I/2,r=O(y,x,_*.65,A);return e.jsxs("g",{children:[e.jsx("path",{d:ce(y,x,_,b,w),fill:g.color,stroke:"#0a0e1a",strokeWidth:"2",opacity:m&&!a?.4:.9}),e.jsx("text",{x:r.x,y:r.y,textAnchor:"middle",dominantBaseline:"central",fill:"white",fontFamily:"Inter, system-ui, sans-serif",fontSize:"12",fontWeight:"800",transform:`rotate(${A}, ${r.x}, ${r.y})`,children:g.value})]},N)}),e.jsx("circle",{cx:y,cy:x,r:22,fill:"#111827",stroke:"#1e293b",strokeWidth:"3"}),e.jsx("circle",{cx:y,cy:x,r:10,fill:"#3b82f6"})]})})]}),f!==null&&e.jsxs("div",{className:"game-panel px-6 py-3 text-center",children:[e.jsx("p",{className:"text-muted text-xs",children:"You won"}),e.jsxs("p",{className:"text-gold text-lg font-bold mt-1",children:[f," XP"]})]}),m&&!a&&M&&e.jsx("p",{className:"text-gold text-sm text-center max-w-xs",children:M}),C&&e.jsx("p",{className:"text-crimson text-sm text-center",children:C}),e.jsx("button",{onClick:p,disabled:a||m,className:`game-btn game-btn-blue text-base px-10 py-3 ${a||m?"opacity-50 cursor-not-allowed":""}`,children:a?"SPINNING...":m?"LOCKED":"SPIN!"})]})}function me(){const t=new Date,i=t.getDay(),a=i===0?-6:1-i,l=new Date(t);return l.setDate(t.getDate()+a),l.toISOString().slice(0,10)}function xe(){return new Date().toISOString().slice(0,10)}function ue(t){switch(t){case"easy":return{text:"Easy",color:"text-emerald bg-emerald/10 border-emerald/20"};case"medium":return{text:"Medium",color:"text-gold bg-gold/10 border-gold/20"};case"hard":return{text:"Hard",color:"text-orange-400 bg-orange-400/10 border-orange-400/20"};case"expert":return{text:"Expert",color:"text-crimson bg-crimson/10 border-crimson/20"};default:return{text:"Easy",color:"text-emerald bg-emerald/10 border-emerald/20"}}}const fe={hidden:{opacity:0,y:12},visible:t=>({opacity:1,y:0,transition:{delay:t*.05,type:"spring",stiffness:300,damping:28}})},pe={idle:{scale:1},tap:{scale:.96}};function Me(){const{user:t,updateUser:i}=Y(),[a,l]=o.useState([]),[s,c]=o.useState([]),[f,h]=o.useState(null),[S,k]=o.useState(!0),[C,j]=o.useState(null),[T,z]=o.useState(null),[M,m]=o.useState(!1),[p,y]=o.useState({}),x=o.useCallback(async()=>{try{j(null);const r=me(),d=xe(),[n,u,v]=await Promise.all([E("/api/chores"),E(`/api/calendar?week_start=${r}`),E("/api/spin/availability")]);c(n);const R=u.days&&u.days[d]||[];l(R),h(v)}catch(r){j(r.message||"Failed to load quest data")}finally{k(!1)}},[]);o.useEffect(()=>{x()},[x]),o.useEffect(()=>{const r=()=>{x()};return window.addEventListener("ws:message",r),()=>window.removeEventListener("ws:message",r)},[x]);const _=async r=>{const d=r.chore_id,n=r.chore;if(!(n!=null&&n.requires_photo&&!p[d])){z(d);try{if(n!=null&&n.requires_photo&&p[d]){const u=new FormData;u.append("file",p[d]),await E(`/api/chores/${d}/complete`,{method:"POST",body:u})}else await E(`/api/chores/${d}/complete`,{method:"POST"});m(!0),n!=null&&n.points&&t&&i({points_balance:t.points_balance+n.points}),y(u=>{const v={...u};return delete v[d],v}),await x()}catch(u){j(u.message||"Failed to complete quest")}finally{z(null)}}},g=(r,d)=>{y(n=>({...n,[r]:d}))};function N(r){return r==="verified"?e.jsxs("span",{className:"inline-flex items-center gap-1 text-emerald text-xs font-medium bg-emerald/10 px-2 py-0.5 rounded-full",children:[e.jsx(Z,{size:12})," Verified"]}):r==="completed"?e.jsxs("span",{className:"inline-flex items-center gap-1 text-gold text-xs font-medium bg-gold/10 px-2 py-0.5 rounded-full",children:[e.jsx(se,{size:12})," Pending"]}):null}if(S)return e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsx(W,{className:"animate-spin text-sky",size:28})});const b=a.filter(r=>r.status==="verified"||r.status==="completed").length,w=a.length,A=w>0?Math.round(b/w*100):0;return e.jsxs("div",{className:"max-w-2xl mx-auto space-y-5",children:[e.jsx(X,{children:M&&e.jsx(K,{onComplete:()=>m(!1)})}),e.jsxs("div",{className:"game-panel p-5",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 flex-wrap mb-4",children:[e.jsx("h1",{className:"font-heading text-cream text-xl font-extrabold",children:"Quest Board"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ae,{value:(t==null?void 0:t.points_balance)??0}),e.jsx(oe,{streak:(t==null?void 0:t.current_streak)??0})]})]}),w>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[e.jsx("span",{className:"text-muted text-xs font-medium",children:"Today's Progress"}),e.jsxs("span",{className:"text-cream text-xs font-bold",children:[b,"/",w]})]}),e.jsx("div",{className:"xp-bar",children:e.jsx(P.div,{className:"xp-bar-fill",initial:{width:0},animate:{width:`${A}%`},transition:{duration:.8,ease:[.22,1,.36,1]}})})]})]}),C&&e.jsxs("div",{className:"game-panel p-3 flex items-center gap-2 border-crimson/30 text-crimson text-sm",children:[e.jsx(J,{size:16}),e.jsx("span",{children:C})]}),a.length===0&&!S?e.jsxs(P.div,{className:"game-panel p-10 flex flex-col items-center gap-3 text-center",initial:{opacity:0,y:12},animate:{opacity:1,y:0},children:[e.jsx(ee,{size:36,className:"text-muted"}),e.jsx("p",{className:"text-muted text-sm",children:"No quests for today. Take a break!"})]}):e.jsx("div",{className:"space-y-3",children:a.map((r,d)=>{var $,q;const n=r.chore;if(!n)return null;const u=r.status==="pending",v=T===n.id,R=ue(n.difficulty),Q=(($=n.category)==null?void 0:$.colour)||"#3b82f6";return e.jsx(P.div,{className:"game-panel p-4 transition-all",variants:fe,initial:"hidden",animate:"visible",custom:d,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"mt-0.5 w-1 h-12 rounded-full flex-shrink-0",style:{backgroundColor:Q}}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1.5",children:[e.jsx("h3",{className:"text-cream text-sm font-semibold truncate",children:n.title}),N(r.status)]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"inline-flex items-center gap-1 text-gold text-xs font-semibold",children:[e.jsx(U,{size:12,fill:"currentColor"}),n.points," XP"]}),e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold border ${R.color}`,children:R.text}),((q=n.category)==null?void 0:q.name)&&e.jsx("span",{className:"text-muted text-xs",children:n.category.name})]}),n.requires_photo&&u&&e.jsx("div",{className:"mt-2",children:e.jsxs("label",{className:"inline-flex items-center gap-1.5 text-xs text-muted cursor-pointer hover:text-cream transition-colors bg-surface-raised px-3 py-1.5 rounded-lg border border-border",children:[e.jsx(te,{size:14}),e.jsx("span",{children:p[n.id]?p[n.id].name:"Attach proof photo"}),e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:H=>{var B;return g(n.id,((B=H.target.files)==null?void 0:B[0])||null)}})]})}),u&&e.jsx(P.button,{className:`game-btn game-btn-blue mt-3 w-full sm:w-auto ${v?"opacity-60 cursor-wait":""} ${n.requires_photo&&!p[n.id]?"opacity-40 cursor-not-allowed":""}`,variants:pe,whileTap:"tap",disabled:v||n.requires_photo&&!p[n.id],onClick:()=>_(r),children:v?e.jsxs("span",{className:"flex items-center gap-2 justify-center",children:[e.jsx(W,{size:14,className:"animate-spin"}),"Completing..."]}):"Complete Quest"})]})]})},r.id)})}),e.jsx("div",{className:"pt-2",children:e.jsx(de,{availability:f,onSpinComplete:()=>{x()}})})]})}export{Me as default};
