import{r as o,j as e,b as R,u as W,c as B,a as V,d as G}from"./index-DNIywqZZ.js";import{t as U}from"./questThemeText-BK2D7k-h.js";import{S as F}from"./star-B3_Vd0i4.js";import{m as k}from"./proxy-pUA5QpF8.js";import{F as L}from"./flame-CvdkfdtY.js";import{A as $}from"./index-D52oPGzx.js";import{T as X}from"./triangle-alert-Bnh4vArX.js";import{S as K}from"./sword-DwMj4xjP.js";import{C as H}from"./chevron-right-DMYTKK5d.js";import{C as Q}from"./camera-iIMA5gvZ.js";function Y({value:t=0,prefix:n="XP"}){const[a,r]=o.useState(t),s=o.useRef(t),l=o.useRef(null);return o.useEffect(()=>{const u=s.current,f=t;if(s.current=t,u===f){r(f);return}const w=f-u,S=Math.min(Math.abs(w)*15,1500),y=performance.now();function N(M){const T=M-y,v=Math.min(T/S,1),m=1-Math.pow(1-v,3),p=Math.round(u+w*m);r(p),v<1&&(l.current=requestAnimationFrame(N))}return l.current=requestAnimationFrame(N),()=>{l.current&&cancelAnimationFrame(l.current)}},[t]),e.jsxs("div",{className:"inline-flex items-center gap-1.5",children:[e.jsx(F,{size:16,className:"text-gold fill-gold"}),e.jsxs("span",{className:"font-heading text-gold text-sm font-bold tabular-nums",children:[a.toLocaleString()," ",n]})]})}const Z={scale:[1,1.1,.97,1.05,1],rotate:[-1,2,-2,1,0],transition:{duration:1,repeat:1/0,repeatType:"mirror",ease:"easeInOut"}};function J(t){return t>=30?{size:28,className:"text-orange-400 drop-shadow-[0_0_8px_rgba(251,146,60,0.5)]"}:t>=7?{size:22,className:"text-orange-400"}:{size:18,className:"text-orange-400/70"}}function ee({streak:t=0,longest:n=0}){const[a,r]=o.useState(!1),s=J(t),l=t>=30;return e.jsxs("div",{className:"relative inline-flex items-center gap-1",onMouseEnter:()=>r(!0),onMouseLeave:()=>r(!1),children:[l?e.jsx(k.div,{animate:Z,className:"flex items-center",children:e.jsx(L,{size:s.size,className:s.className})}):e.jsx(L,{size:s.size,className:s.className}),e.jsx("span",{className:"font-bold text-orange-400 text-sm tabular-nums",children:t}),a&&e.jsxs("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-1.5 bg-surface-raised border border-border rounded-lg text-center whitespace-nowrap z-10 shadow-lg",children:[e.jsxs("p",{className:"text-cream text-xs font-medium",children:[t," day streak"]}),e.jsxs("p",{className:"text-muted text-[10px]",children:["Best: ",n]}),e.jsx("div",{className:"absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-[5px] border-l-transparent border-r-[5px] border-r-transparent border-t-[5px] border-t-border"})]})]})}const O=["#3b82f6","#10b981","#f59e0b","#a855f7","#ef4444","#60a5fa"],te=30,_=3;function P(t,n){return Math.random()*(n-t)+t}function se(){return Array.from({length:te},(t,n)=>{const a=P(0,Math.PI*2),r=P(200,500),s=P(6,14),l=Math.random()>.5?"circle":"rect";return{id:n,color:O[Math.floor(Math.random()*O.length)],x:Math.cos(a)*r,y:Math.sin(a)*r,rotation:P(0,720),size:s,shape:l}})}function q({onComplete:t}){const[n,a]=o.useState(!0),r=o.useMemo(()=>se(),[]);return o.useEffect(()=>{const s=setTimeout(()=>{a(!1),t==null||t()},_*1e3);return()=>clearTimeout(s)},[t]),e.jsx($,{children:n&&e.jsx("div",{className:"fixed inset-0 z-[100] pointer-events-none overflow-hidden",children:r.map(s=>e.jsx(k.div,{className:"absolute",style:{left:"50%",top:"40%",width:s.shape==="circle"?s.size:s.size*.7,height:s.size,backgroundColor:s.color,borderRadius:s.shape==="circle"?"50%":"2px"},initial:{x:0,y:0,opacity:1,rotate:0,scale:1},animate:{x:s.x,y:[0,s.y*.4,s.y+300],opacity:[1,1,0],rotate:s.rotation,scale:[1,1.2,.5]},transition:{duration:_,ease:[.25,.46,.45,.94],y:{duration:_,ease:[.22,.61,.36,1]}}},s.id))})})}const I=[{value:1,color:"#ef4444"},{value:5,color:"#f59e0b"},{value:2,color:"#10b981"},{value:10,color:"#a855f7"},{value:3,color:"#3b82f6"},{value:15,color:"#f97316"},{value:1,color:"#ec4899"},{value:25,color:"#f59e0b"},{value:2,color:"#06b6d4"},{value:5,color:"#10b981"},{value:3,color:"#a855f7"},{value:10,color:"#ef4444"}],E=360/I.length;function D(t,n,a,r){const s=(r-90)*Math.PI/180;return{x:t+a*Math.cos(s),y:n+a*Math.sin(s)}}function ae(t,n,a,r,s){const l=D(t,n,a,s),u=D(t,n,a,r),f=s-r<=180?"0":"1";return["M",t,n,"L",l.x,l.y,"A",a,a,0,f,0,u.x,u.y,"Z"].join(" ")}function ne({availability:t,onSpinComplete:n}){const[a,r]=o.useState(!1),[s,l]=o.useState(0),[u,f]=o.useState(null),[w,S]=o.useState(!1),[y,N]=o.useState(null),M=o.useRef(!1),T=(t==null?void 0:t.can_spin)??!0,v=(t==null?void 0:t.reason)??null,m=!T,p=o.useCallback(async()=>{if(!(a||m)){r(!0),f(null),N(null);try{const i=await R("/api/spin/spin",{method:"POST"}),d=i.points_won??i.points??i.result??5;let x=I.findIndex(A=>A.value===d);x===-1&&(x=Math.floor(Math.random()*I.length));const c=x*E+E/2,g=5+Math.floor(Math.random()*3),b=s+g*360+(360-c);l(b),setTimeout(()=>{f(d),S(!0),r(!1),M.current=!0,n==null||n(d)},3500)}catch(i){N(i.message||"Spin failed!"),r(!1)}}},[a,m,s,n]),j=150,h=150,z=140;return e.jsxs("div",{className:"flex flex-col items-center gap-5",children:[w&&e.jsx(q,{onComplete:()=>S(!1)}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1 z-10",children:e.jsx("div",{className:"w-0 h-0 border-l-[12px] border-l-transparent border-r-[12px] border-r-transparent border-t-[20px] border-t-sky",style:{filter:"drop-shadow(0 2px 6px rgba(59,130,246,0.4))"}})}),e.jsx(k.div,{animate:{rotate:s},transition:{duration:3.5,ease:[.2,.8,.3,1]},className:"w-[300px] h-[300px]",children:e.jsxs("svg",{width:"300",height:"300",viewBox:"0 0 300 300",className:"drop-shadow-xl",children:[e.jsx("circle",{cx:j,cy:h,r:z+4,fill:"none",stroke:"#1e293b",strokeWidth:"4"}),I.map((i,d)=>{const x=d*E,c=x+E,g=x+E/2,b=D(j,h,z*.65,g);return e.jsxs("g",{children:[e.jsx("path",{d:ae(j,h,z,x,c),fill:i.color,stroke:"#0a0e1a",strokeWidth:"2",opacity:m&&!a?.4:.9}),e.jsx("text",{x:b.x,y:b.y,textAnchor:"middle",dominantBaseline:"central",fill:"white",fontFamily:"Inter, system-ui, sans-serif",fontSize:"12",fontWeight:"800",transform:`rotate(${g}, ${b.x}, ${b.y})`,children:i.value})]},d)}),e.jsx("circle",{cx:j,cy:h,r:22,fill:"#111827",stroke:"#1e293b",strokeWidth:"3"}),e.jsx("circle",{cx:j,cy:h,r:10,fill:"#3b82f6"})]})})]}),u!==null&&e.jsxs("div",{className:"game-panel px-6 py-3 text-center",children:[e.jsx("p",{className:"text-muted text-xs",children:"You won"}),e.jsxs("p",{className:"text-gold text-lg font-bold mt-1",children:[u," XP"]})]}),m&&!a&&v&&e.jsx("p",{className:"text-gold text-sm text-center max-w-xs",children:v}),y&&e.jsx("p",{className:"text-crimson text-sm text-center",children:y}),e.jsx("button",{onClick:p,disabled:a||m,className:`game-btn game-btn-blue text-base px-10 py-3 ${a||m?"opacity-50 cursor-not-allowed":""}`,children:a?"SPINNING...":m?"LOCKED":"SPIN!"})]})}function re(){const t=new Date,n=t.getDay(),a=n===0?-6:1-n,r=new Date(t);return r.setDate(t.getDate()+a),r.toISOString().slice(0,10)}function oe(){return new Date().toISOString().slice(0,10)}function ie(t){switch(t){case"easy":return{text:"Easy",color:"text-emerald bg-emerald/10 border-emerald/20"};case"medium":return{text:"Medium",color:"text-gold bg-gold/10 border-gold/20"};case"hard":return{text:"Hard",color:"text-orange-400 bg-orange-400/10 border-orange-400/20"};case"expert":return{text:"Expert",color:"text-crimson bg-crimson/10 border-crimson/20"};default:return{text:"Easy",color:"text-emerald bg-emerald/10 border-emerald/20"}}}const le={hidden:{opacity:0,y:12},visible:t=>({opacity:1,y:0,transition:{delay:t*.05,type:"spring",stiffness:300,damping:28}})};function je(){const{user:t,updateUser:n}=W(),{colorTheme:a}=B(),r=V(),[s,l]=o.useState([]),[u,f]=o.useState([]),[w,S]=o.useState(null),[y,N]=o.useState(!0),[M,T]=o.useState(null),[v,m]=o.useState(!1),p=o.useCallback(async()=>{try{T(null);const i=re(),d=oe(),[x,c,g]=await Promise.all([R("/api/chores"),R(`/api/calendar?week_start=${i}`),R("/api/spin/availability")]);f(x);const A=(c.days&&c.days[d]||[]).filter(C=>C.user_id===(t==null?void 0:t.id));l(A),S(g)}catch(i){T(i.message||"Failed to load quest data")}finally{N(!1)}},[t==null?void 0:t.id]);if(o.useEffect(()=>{p()},[p]),o.useEffect(()=>{const i=()=>{p()};return window.addEventListener("ws:message",i),()=>window.removeEventListener("ws:message",i)},[p]),y)return e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsx(G,{className:"animate-spin text-sky",size:28})});const j=s.filter(i=>i.status==="verified"||i.status==="completed").length,h=s.length,z=h>0?Math.round(j/h*100):0;return e.jsxs("div",{className:"max-w-2xl mx-auto space-y-5",children:[e.jsx($,{children:v&&e.jsx(q,{onComplete:()=>m(!1)})}),e.jsxs("div",{className:"game-panel p-5",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 flex-wrap mb-4",children:[e.jsx("h1",{className:"font-heading text-cream text-xl font-extrabold",children:"Quest Board"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Y,{value:(t==null?void 0:t.points_balance)??0}),e.jsx(ee,{streak:(t==null?void 0:t.current_streak)??0})]})]}),h>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[e.jsx("span",{className:"text-muted text-xs font-medium",children:"Today's Progress"}),e.jsxs("span",{className:"text-cream text-xs font-bold",children:[j,"/",h]})]}),e.jsx("div",{className:"xp-bar",children:e.jsx(k.div,{className:"xp-bar-fill",initial:{width:0},animate:{width:`${z}%`},transition:{duration:.8,ease:[.22,1,.36,1]}})})]})]}),M&&e.jsxs("div",{className:"game-panel p-3 flex items-center gap-2 border-crimson/30 text-crimson text-sm",children:[e.jsx(X,{size:16}),e.jsx("span",{children:M})]}),(()=>{const i=s.filter(d=>d.status==="pending"||d.status==="assigned");return i.length===0&&!y?e.jsxs(k.div,{className:"game-panel p-10 flex flex-col items-center gap-3 text-center",initial:{opacity:0,y:12},animate:{opacity:1,y:0},children:[e.jsx(K,{size:36,className:"text-muted"}),e.jsx("p",{className:"text-muted text-sm",children:s.length===0?"No quests for today. Take a break!":"All quests complete! Time to spin the wheel!"})]}):e.jsx("div",{className:"space-y-3",children:i.map((d,x)=>{var A,C;const c=d.chore;if(!c)return null;const g=ie(c.difficulty),b=((A=c.category)==null?void 0:A.colour)||"#3b82f6";return e.jsx(k.div,{className:"game-panel p-4 transition-all cursor-pointer hover:border-sky/40",variants:le,initial:"hidden",animate:"visible",custom:x,onClick:()=>r("/chores"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"mt-0.5 w-1 h-12 rounded-full flex-shrink-0",style:{backgroundColor:b}}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1.5",children:[e.jsx("h3",{className:"text-cream text-sm font-semibold truncate",children:U(c.title,a)}),e.jsx(H,{size:16,className:"text-muted flex-shrink-0"})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"inline-flex items-center gap-1 text-gold text-xs font-semibold",children:[e.jsx(F,{size:12,fill:"currentColor"}),c.points," XP"]}),e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold border ${g.color}`,children:g.text}),((C=c.category)==null?void 0:C.name)&&e.jsx("span",{className:"text-muted text-xs",children:c.category.name}),c.requires_photo&&e.jsxs("span",{className:"inline-flex items-center gap-1 text-muted text-xs",children:[e.jsx(Q,{size:10}),"Photo"]})]})]})]})},d.id)})})})(),e.jsx("div",{className:"pt-2",children:e.jsx(ne,{availability:w,onSpinComplete:()=>{p()}})})]})}export{je as default};
