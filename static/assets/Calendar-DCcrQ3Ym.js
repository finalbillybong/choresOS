import{a as ae,u as re,r as a,b as C,j as e,i as Q,f as H}from"./index-BrdgRyQB.js";import{M as ne}from"./Modal-C5zO3N_b.js";import{C as oe}from"./chevron-left-BQLDQEpA.js";import{C as ie}from"./chevron-right-D_YW6MT8.js";import{L as de}from"./loader-circle-Dj6CXswZ.js";import{A as ce,S as le}from"./slash-DsEbXLtj.js";import{C as Y}from"./clock-r5nlkPGZ.js";import"./index-B_q95wpO.js";import"./proxy-gvXsNLCl.js";function O(i){return i.toISOString().slice(0,10)}function o(i,c){const l=new Date(i+"T00:00:00");return l.setDate(l.getDate()+c),l.toISOString().slice(0,10)}const me=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function xe(i,c){const l=new Date().toISOString().slice(0,10);return i.status==="verified"?{border:"border-emerald",bg:"bg-emerald/10",icon:e.jsx(H,{size:16,className:"text-emerald"})}:i.status==="completed"?{border:"border-emerald",bg:"bg-emerald/5",icon:e.jsx(H,{size:16,className:"text-emerald/60"})}:i.status==="skipped"?{border:"border-border",bg:"bg-navy-light/50",icon:e.jsx(le,{size:16,className:"text-muted"}),textClass:"line-through text-muted"}:c<l?{border:"border-crimson",bg:"bg-crimson/5",icon:e.jsx(Y,{size:16,className:"text-crimson"})}:{border:"border-border",bg:"",icon:e.jsx(Y,{size:16,className:"text-muted"})}}function ve(){var F;const i=ae(),{user:c}=re(),l=(c==null?void 0:c.role)==="kid",[r,T]=a.useState(()=>O(new Date)),[E,B]=a.useState({}),[D,L]=a.useState(!0),[_,$]=a.useState(""),[G,y]=a.useState(!1),[x,J]=a.useState(null),[K,A]=a.useState([]),[f,M]=a.useState(""),[I,P]=a.useState(!1),[R,j]=a.useState(""),p=a.useCallback(async()=>{var t,u,n;L(!0),$("");try{const N=new Date(r+"T00:00:00").getDay(),z=N===0?-6:1-N,b=o(r,z),s=await C(`/api/calendar?week_start=${b}`),d={};for(let m=0;m<7;m++){const g=o(r,m);d[g]=((t=s.days)==null?void 0:t[g])||[]}const v=o(b,7),w=o(r,6),S=o(b,6);if(w>S)try{const m=await C(`/api/calendar?week_start=${v}`);for(let g=0;g<7;g++){const k=o(r,g);!((u=d[k])!=null&&u.length)&&((n=m.days)!=null&&n[k])&&(d[k]=m.days[k])}}catch{}B(d)}catch(h){$(h.message||"Failed to load calendar")}finally{L(!1)}},[r]);a.useEffect(()=>{p()},[p]),a.useEffect(()=>{const t=()=>{p()};return window.addEventListener("ws:message",t),()=>window.removeEventListener("ws:message",t)},[p]);const U=()=>T(o(r,-7)),V=()=>T(o(r,7)),X=()=>T(O(new Date)),Z=async t=>{J(t),j(""),M(""),y(!0);try{const n=(await C("/api/stats/kids")||[]).filter(h=>h.id!==c.id);A(n)}catch{A([])}},ee=async()=>{if(!f){j("Select a hero to trade with");return}P(!0),j("");try{await C("/api/calendar/trade",{method:"POST",body:{assignment_id:x.id,target_user_id:f}}),y(!1),p()}catch(t){j(t.message||"Trade failed")}finally{P(!1)}},te=o(r,6),W=O(new Date),se=r===W,q=t=>new Date(t+"T00:00:00").toLocaleDateString(void 0,{month:"short",day:"numeric"});return e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Q,{size:28,className:"text-sky"}),e.jsx("h1",{className:"text-cream text-xl font-extrabold leading-relaxed",children:"Quest Calendar"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:U,className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-cream","aria-label":"Previous week",children:e.jsx(oe,{size:20})}),e.jsxs("span",{className:"text-cream text-sm min-w-[180px] text-center",children:[q(r)," â€“ ",q(te)]}),e.jsx("button",{onClick:V,className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-cream","aria-label":"Next 7 days",children:e.jsx(ie,{size:20})}),!se&&e.jsx("button",{onClick:X,className:"game-btn game-btn-blue ml-2",children:"Today"})]})]}),_&&e.jsx("div",{className:"mb-4 p-3 rounded border-2 border-crimson/40 bg-crimson/10 text-crimson text-sm text-center",children:_}),D&&e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx(de,{size:32,className:"text-sky animate-spin"})}),!D&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-7 gap-3",children:Array.from({length:7},(t,u)=>{const n=o(r,u),h=new Date(n+"T00:00:00"),N=me[h.getDay()],z=n===W,b=E[n]||[];return e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:`text-center py-2 px-1 rounded-t-md border-b-2 ${z?"bg-sky/10 border-sky text-sky":"bg-surface-raised/30 border-border text-muted"}`,children:[e.jsx("div",{className:"text-xs font-bold tracking-wider",children:N}),e.jsx("div",{className:"text-sm mt-1",children:new Date(n+"T00:00:00").getDate()})]}),e.jsxs("div",{className:"space-y-2 mt-2 min-h-[80px]",children:[b.length===0&&e.jsx("p",{className:"text-muted text-xs text-center py-4",children:"No quests"}),b.map(s=>{var v,w,S;const d=xe(s,n);return e.jsxs("div",{className:`game-panel !border-2 ${d.border} ${d.bg} p-2 cursor-pointer hover:brightness-110 transition-all`,onClick:()=>i(`/chores/${s.chore_id||s.id}`),children:[e.jsxs("div",{className:"flex items-start gap-1.5",children:[d.icon,e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:`text-sm leading-tight truncate ${d.textClass||"text-cream"}`,children:((v=s.chore)==null?void 0:v.title)||s.chore_title||"Quest"}),!l&&(((w=s.user)==null?void 0:w.display_name)||s.assigned_to_name)&&e.jsx("p",{className:"text-xs text-purple font-medium mt-0.5 truncate",children:((S=s.user)==null?void 0:S.display_name)||s.assigned_to_name})]})]}),l&&s.status==="pending"&&e.jsxs("button",{onClick:m=>{m.stopPropagation(),Z(s)},className:"mt-1.5 flex items-center gap-1 text-xs font-medium text-sky hover:text-sky/80 transition-colors",children:[e.jsx(ce,{size:12}),"Trade"]})]},s.id)})]})]},n)})}),!D&&!_&&Object.values(E).every(t=>t.length===0)&&e.jsxs("div",{className:"text-center py-16",children:[e.jsx(Q,{size:48,className:"text-muted mx-auto mb-4"}),e.jsx("p",{className:"text-cream text-lg font-bold",children:"No quests scheduled this week"}),e.jsx("p",{className:"text-muted text-sm mt-2",children:"The quest board is empty. Time to plan new adventures!"})]}),e.jsx(ne,{isOpen:G,onClose:()=>y(!1),title:"Propose a Trade",actions:[{label:"Cancel",onClick:()=>y(!1),className:"game-btn game-btn-red"},{label:I?"Sending...":"Send Trade",onClick:ee,className:"game-btn game-btn-blue",disabled:I||!f}],children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-muted text-sm",children:["Trade"," ",e.jsx("span",{className:"text-cream font-bold",children:((F=x==null?void 0:x.chore)==null?void 0:F.title)||(x==null?void 0:x.chore_title)||"Quest"})," ","with another hero:"]}),R&&e.jsx("div",{className:"p-2 rounded border border-crimson/40 bg-crimson/10 text-crimson text-sm",children:R}),K.length===0?e.jsx("p",{className:"text-muted text-sm",children:"No other heroes found in your party."}):e.jsx("div",{className:"space-y-2",children:K.map(t=>e.jsx("button",{onClick:()=>M(t.id),className:`w-full text-left p-3 rounded border-2 transition-colors ${f===t.id?"border-sky bg-sky/10 text-sky":"border-border text-muted hover:border-cream/30"}`,children:e.jsx("span",{className:"text-sm",children:t.display_name||t.username})},t.id))})]})})]})}export{ve as default};
