import{u as qe,a as Ee,r,b as d,j as s,S as L}from"./index-CRKPRXQ3.js";import{M as ae}from"./Modal-DXxDxgzi.js";import{E as Pe,a as De}from"./eye-ctXjR1Dk.js";import{P as ie}from"./plus-Cn1GtUwy.js";import{F as Ae,S as ze,B as Fe}from"./search-C4JcEXxi.js";import{P as Te}from"./pencil-BjeqHbuU.js";import{T as Oe}from"./trash-2-Bvb4709e.js";import{C as le}from"./circle-check-1K7eXh_Y.js";import{C as $}from"./camera-9YqBEvF5.js";import{L as Le}from"./loader-circle-C0n6L0S0.js";import{S as $e}from"./star-COuSHzAw.js";import{R as Re}from"./refresh-cw-BOlNwGFB.js";import"./index-C7kt0K0A.js";import"./proxy-DAeV9c_I.js";const re=[{value:"easy",label:"Easy",level:1},{value:"medium",label:"Medium",level:2},{value:"hard",label:"Hard",level:3},{value:"expert",label:"Expert",level:4}],Me={easy:1,medium:2,hard:3,expert:4},Qe=[{value:"once",label:"One-time"},{value:"daily",label:"Daily"},{value:"weekly",label:"Weekly"},{value:"custom",label:"Custom Days"}],ce=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],ne={cleaning:"bg-sky/20 text-sky border-sky/40",cooking:"bg-gold/20 text-gold border-gold/40",outdoor:"bg-emerald/20 text-emerald border-emerald/40",homework:"bg-purple/20 text-purple border-purple/40",pet_care:"bg-crimson/20 text-crimson border-crimson/40",laundry:"bg-sky/20 text-sky border-sky/40",errands:"bg-gold/20 text-gold border-gold/40",default:"bg-cream/10 text-muted border-border"},N="bg-navy-light border-2 border-border text-cream p-2 rounded text-sm focus:border-sky focus:outline-none transition-colors";function Ie({level:i}){const n=typeof i=="string"?Me[i]||1:i||1;return s.jsx("div",{className:"flex items-center gap-0.5",children:[1,2,3,4].map(o=>s.jsx($e,{size:14,className:o<=n?"text-gold fill-gold":"text-muted"},o))})}function Ke({category:i}){const n=typeof i=="object"?i==null?void 0:i.name:i,o=ne[n==null?void 0:n.toLowerCase()]||ne.default;return s.jsx("span",{className:`inline-block px-2 py-0.5 rounded-full text-xs border ${o} capitalize`,children:n||"General"})}function Ue({recurrence:i,customDays:n}){return!i||i==="once"?null:s.jsxs("div",{className:"flex items-center gap-1 text-muted text-xs",children:[s.jsx(Re,{size:12}),s.jsx("span",{className:"capitalize",children:i}),i==="custom"&&(n==null?void 0:n.length)>0&&s.jsxs("span",{className:"text-muted",children:["(",n.map(o=>ce[o]||o).join(", "),")"]})]})}const oe={title:"",description:"",points:10,difficulty:"easy",category_id:"",recurrence:"once",custom_days:[],requires_photo:!1,assigned_user_ids:[]};function Be(){const i=new Date,n=i.getDay(),o=n===0?-6:1-n,m=new Date(i);return m.setDate(i.getDate()+o),m.toISOString().slice(0,10)}function Xe(){return new Date().toISOString().slice(0,10)}function ns(){var se;const{user:i,updateUser:n}=qe(),o=Ee(),m=(i==null?void 0:i.role)==="parent"||(i==null?void 0:i.role)==="admin",u=(i==null?void 0:i.role)==="kid",[h,de]=r.useState([]),[R,me]=r.useState([]),[M,Q]=r.useState([]),[ue,xe]=r.useState([]),[pe,fe]=r.useState(!0),[I,_]=r.useState(""),[E,ge]=r.useState(""),[P,he]=r.useState(""),[w,be]=r.useState(""),[D,ye]=r.useState(!1),[K,A]=r.useState(!1),[C,z]=r.useState(null),[l,b]=r.useState({...oe}),[U,x]=r.useState(""),[B,F]=r.useState(!1),[y,k]=r.useState(null),[X,Y]=r.useState(!1),[je,H]=r.useState(null),[p,W]=r.useState({}),j=r.useCallback(async()=>{try{_("");const e=await d("/api/chores");de(Array.isArray(e)?e:e.chores||e.items||[])}catch(e){_(e.message||"Failed to load quests from the guild board.")}},[]),S=r.useCallback(async()=>{if(u)try{const e=Be(),t=Xe(),a=await d(`/api/calendar?week_start=${e}`),c=a.days&&a.days[t]||[];xe(c)}catch{}},[u]),G=r.useCallback(async()=>{try{const e=await d("/api/chores/categories");me(Array.isArray(e)?e:e.categories||[])}catch{}},[]),V=r.useCallback(async()=>{if(m)try{const e=await d("/api/stats/family");Q(Array.isArray(e)?e:[])}catch{try{const e=await d("/api/admin/users"),t=Array.isArray(e)?e:e.users||[];Q(t.filter(a=>a.role==="kid"))}catch{}}},[m]),T=r.useCallback(async()=>{await Promise.all([j(),S(),G(),V()])},[j,S,G,V]);r.useEffect(()=>{T().finally(()=>fe(!1))},[T]),r.useEffect(()=>{const e=()=>{j(),S()};return window.addEventListener("ws:message",e),()=>window.removeEventListener("ws:message",e)},[j,S]);const ve=async e=>{const t=e.id;if(!(e.requires_photo&&!p[t])){H(t);try{if(e.requires_photo&&p[t]){const a=new FormData;a.append("file",p[t]),await d(`/api/chores/${t}/complete`,{method:"POST",body:a})}else await d(`/api/chores/${t}/complete`,{method:"POST"});e.points&&i&&n({points_balance:i.points_balance+e.points}),W(a=>{const c={...a};return delete c[t],c}),await T()}catch(a){_(a.message||"Failed to complete quest")}finally{H(null)}}},q={};if(u)for(const e of ue){const t=e.chore_id||((se=e.chore)==null?void 0:se.id);t&&(q[t]=e.status)}const J=h.filter(e=>{var t,a,c;if(E&&((t=e.category)==null?void 0:t.name)!==E||P&&e.difficulty!==P||w&&!((a=e.title)!=null&&a.toLowerCase().includes(w.toLowerCase()))&&!((c=e.description)!=null&&c.toLowerCase().includes(w.toLowerCase())))return!1;if(u&&!D){const v=q[e.id];if(v==="completed"||v==="verified")return!1}return!0}),Z=u?Object.values(q).filter(e=>e==="completed"||e==="verified").length:0,ee=()=>{z(null),b({...oe}),x(""),A(!0)},Ne=e=>{z(e),b({title:e.title||"",description:e.description||"",points:e.points||10,difficulty:e.difficulty||"easy",category_id:e.category_id?String(e.category_id):"",recurrence:e.recurrence||"once",custom_days:e.custom_days||[],requires_photo:e.requires_photo||!1,assigned_user_ids:e.assigned_user_ids||e.assigned_kids||e.assigned_to||[]}),x(""),A(!0)},O=()=>{A(!1),z(null),x("")},f=(e,t)=>{b(a=>({...a,[e]:t}))},Ce=e=>{b(t=>({...t,custom_days:t.custom_days.includes(e)?t.custom_days.filter(a=>a!==e):[...t.custom_days,e]}))},_e=e=>{b(t=>({...t,assigned_user_ids:t.assigned_user_ids.includes(e)?t.assigned_user_ids.filter(a=>a!==e):[...t.assigned_user_ids,e]}))},we=async()=>{if(!l.title.trim()){x("Every quest needs a name, adventurer!");return}if(l.points<1){x("The reward must be at least 1 XP.");return}F(!0),x("");const e={title:l.title.trim(),description:l.description.trim()||null,points:Number(l.points),difficulty:l.difficulty,category_id:l.category_id?Number(l.category_id):void 0,recurrence:l.recurrence,requires_photo:l.requires_photo,assigned_user_ids:l.assigned_user_ids.length>0?l.assigned_user_ids:[]};if(!e.category_id){x("Please select a category for this quest."),F(!1);return}l.recurrence==="custom"&&(e.custom_days=l.custom_days);try{C?await d(`/api/chores/${C.id}`,{method:"PUT",body:e}):await d("/api/chores",{method:"POST",body:e}),O(),await j()}catch(t){x(t.message||"The quest scroll could not be saved.")}finally{F(!1)}},ke=async()=>{if(y){Y(!0);try{await d(`/api/chores/${y.id}`,{method:"DELETE"}),k(null),await j()}catch(e){_(e.message||"Failed to remove the quest.")}finally{Y(!1)}}};return pe?s.jsxs("div",{className:"flex flex-col items-center justify-center py-20 gap-4",children:[s.jsx(L,{size:48,className:"text-sky animate-pulse"}),s.jsx("p",{className:"text-cream text-lg font-bold animate-pulse",children:"Loading quests from the guild board..."})]}):s.jsxs("div",{className:"max-w-5xl mx-auto space-y-6",children:[s.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(L,{size:28,className:"text-sky"}),s.jsx("h1",{className:"text-cream text-xl font-extrabold leading-relaxed",children:m?"Quest Management":"My Quests"})]}),s.jsxs("div",{className:"flex items-center gap-3",children:[u&&Z>0&&s.jsxs("button",{onClick:()=>ye(e=>!e),className:"flex items-center gap-1.5 text-muted hover:text-cream text-sm transition-colors",children:[D?s.jsx(Pe,{size:16}):s.jsx(De,{size:16}),D?"Hide":"Show"," completed (",Z,")"]}),m&&s.jsxs("button",{onClick:ee,className:"game-btn game-btn-blue flex items-center gap-2",children:[s.jsx(ie,{size:16}),"Create Quest"]})]})]}),I&&s.jsx("div",{className:"p-3 rounded border-2 border-crimson/40 bg-crimson/10 text-crimson text-sm text-center",children:I}),s.jsx("div",{className:"game-panel p-4",children:s.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-3",children:[s.jsxs("div",{className:"flex items-center gap-2 text-muted",children:[s.jsx(Ae,{size:16}),s.jsx("span",{className:"text-sm",children:"Filters:"})]}),s.jsxs("div",{className:"relative flex-1 min-w-0",children:[s.jsx(ze,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted"}),s.jsx("input",{type:"text",placeholder:"Search quests...",value:w,onChange:e=>be(e.target.value),className:"field-input pl-9 py-2"})]}),s.jsxs("select",{value:E,onChange:e=>ge(e.target.value),className:N,children:[s.jsx("option",{value:"",children:"All Categories"}),R.map(e=>s.jsx("option",{value:e.name,children:e.name},e.id))]}),s.jsxs("select",{value:P,onChange:e=>he(e.target.value),className:N,children:[s.jsx("option",{value:"",children:"All Difficulties"}),re.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))]})]})}),J.length===0?s.jsxs("div",{className:"game-panel p-10 text-center",children:[s.jsx(L,{size:40,className:"mx-auto text-muted mb-4"}),s.jsx("p",{className:"text-muted text-sm",children:h.length===0?"The quest board is empty. No adventures await... yet!":"No quests match your search. Try adjusting the filters."}),m&&h.length===0&&s.jsxs("button",{onClick:ee,className:"game-btn game-btn-blue mt-4 inline-flex items-center gap-2",children:[s.jsx(ie,{size:16}),"Post First Quest"]})]}):s.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-3",children:J.map(e=>{const t=u?q[e.id]:null,a=t==="completed"||t==="verified",c=u&&(t==="pending"||t==="assigned"),v=je===e.id;return s.jsxs("div",{className:`game-panel p-4 flex flex-col gap-3 cursor-pointer hover:border-sky/40 transition-colors ${a?"opacity-50":""}`,onClick:()=>o(`/chores/${e.id}`),children:[s.jsxs("div",{className:"flex items-start justify-between gap-2",children:[s.jsx("h3",{className:"text-cream text-lg font-bold leading-relaxed flex-1",children:e.title}),m&&s.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[s.jsx("button",{onClick:g=>{g.stopPropagation(),Ne(e)},className:"p-1.5 rounded hover:bg-surface-raised transition-colors text-muted hover:text-sky","aria-label":"Edit quest",children:s.jsx(Te,{size:14})}),s.jsx("button",{onClick:g=>{g.stopPropagation(),k(e)},className:"p-1.5 rounded hover:bg-surface-raised transition-colors text-muted hover:text-crimson","aria-label":"Delete quest",children:s.jsx(Oe,{size:14})})]}),a&&s.jsx(le,{size:18,className:"text-emerald flex-shrink-0"})]}),e.description&&s.jsx("p",{className:"text-muted text-sm line-clamp-2",children:e.description}),s.jsxs("div",{className:"flex items-center flex-wrap gap-2 mt-auto",children:[s.jsxs("span",{className:"flex items-center gap-1 text-gold font-bold text-sm",children:[s.jsx("span",{className:"text-lg",children:"â˜…"}),e.points," XP"]}),s.jsx(Ie,{level:e.difficulty||1})]}),s.jsxs("div",{className:"flex items-center flex-wrap gap-2",children:[s.jsx(Ke,{category:e.category}),s.jsx(Ue,{recurrence:e.recurrence,customDays:e.custom_days}),e.requires_photo&&s.jsxs("span",{className:"flex items-center gap-1 text-muted text-xs",children:[s.jsx($,{size:12}),"Photo"]})]}),c&&s.jsxs("div",{className:"mt-1 space-y-2",onClick:g=>g.stopPropagation(),children:[e.requires_photo&&s.jsxs("label",{className:"inline-flex items-center gap-1.5 text-xs text-muted cursor-pointer hover:text-cream transition-colors bg-surface-raised px-3 py-1.5 rounded-lg border border-border",children:[s.jsx($,{size:14}),s.jsx("span",{children:p[e.id]?p[e.id].name:"Attach proof photo"}),s.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:g=>W(Se=>{var te;return{...Se,[e.id]:((te=g.target.files)==null?void 0:te[0])||null}})})]}),s.jsx("button",{onClick:()=>ve(e),disabled:v||e.requires_photo&&!p[e.id],className:`game-btn game-btn-blue w-full flex items-center justify-center gap-2 ${v?"opacity-60 cursor-wait":""} ${e.requires_photo&&!p[e.id]?"opacity-40 cursor-not-allowed":""}`,children:v?s.jsxs(s.Fragment,{children:[s.jsx(Le,{size:14,className:"animate-spin"}),"Completing..."]}):s.jsxs(s.Fragment,{children:[s.jsx(le,{size:14}),"Complete Quest"]})})]})]},e.id)})}),s.jsx(ae,{isOpen:K,onClose:O,title:C?"Edit Quest Scroll":"New Quest Scroll",actions:[{label:"Cancel",onClick:O,className:"game-btn game-btn-blue"},{label:B?"Saving...":C?"Update Quest":"Create Quest",onClick:we,className:"game-btn game-btn-gold",disabled:B}],children:s.jsxs("div",{className:"space-y-4",children:[U&&s.jsx("div",{className:"p-2 rounded border border-crimson/40 bg-crimson/10 text-crimson text-sm",children:U}),!C&&h.length>0&&s.jsxs("div",{children:[s.jsxs("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide flex items-center gap-1.5",children:[s.jsx(Fe,{size:14}),"Start from existing quest"]}),s.jsxs("select",{defaultValue:"",onChange:e=>{const t=e.target.value;if(!t)return;const a=h.find(c=>String(c.id)===t);a&&b({title:a.title||"",description:a.description||"",points:a.points||10,difficulty:a.difficulty||"easy",category_id:a.category_id?String(a.category_id):"",recurrence:a.recurrence||"once",custom_days:a.custom_days||[],requires_photo:a.requires_photo||!1,assigned_user_ids:[]})},className:`${N} w-full p-3`,children:[s.jsx("option",{value:"",children:"Create from scratch..."}),h.map(e=>s.jsxs("option",{value:String(e.id),children:[e.title," (",e.points," XP, ",e.difficulty,")"]},e.id))]},`tpl-${K}`),s.jsx("p",{className:"text-muted text-xs mt-1",children:"Pick a quest to pre-fill the form, then customise as needed."})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Quest Name"}),s.jsx("input",{type:"text",value:l.title,onChange:e=>f("title",e.target.value),placeholder:"Defeat the Dust Bunnies",className:"field-input"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Description"}),s.jsx("textarea",{value:l.description,onChange:e=>f("description",e.target.value),placeholder:"Describe the quest details...",rows:3,className:"field-input resize-none"})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"XP Reward"}),s.jsx("input",{type:"number",min:1,value:l.points,onChange:e=>f("points",e.target.value),className:"field-input"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Difficulty"}),s.jsx("select",{value:l.difficulty,onChange:e=>f("difficulty",e.target.value),className:`${N} w-full p-3`,children:re.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Category"}),s.jsxs("select",{value:l.category_id,onChange:e=>f("category_id",e.target.value),className:`${N} w-full p-3`,children:[s.jsx("option",{value:"",children:"Select category..."}),R.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Recurrence"}),s.jsx("select",{value:l.recurrence,onChange:e=>f("recurrence",e.target.value),className:`${N} w-full p-3`,children:Qe.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))})]}),l.recurrence==="custom"&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-2 tracking-wide",children:"Quest Days"}),s.jsx("div",{className:"flex flex-wrap gap-2",children:ce.map((e,t)=>s.jsx("button",{type:"button",onClick:()=>Ce(t),className:`px-3 py-1.5 rounded border-2 text-sm transition-colors ${l.custom_days.includes(t)?"border-sky bg-sky/20 text-sky":"border-border text-muted hover:border-cream/30"}`,children:e},e))})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("label",{className:"text-cream text-sm font-medium tracking-wide flex items-center gap-2",children:[s.jsx($,{size:14}),"Requires Photo Proof"]}),s.jsx("button",{type:"button",onClick:()=>f("requires_photo",!l.requires_photo),className:`relative w-12 h-6 rounded-full border-2 transition-colors ${l.requires_photo?"bg-sky/20 border-sky":"bg-navy-light border-border"}`,children:s.jsx("div",{className:`absolute top-0.5 w-4 h-4 rounded-full transition-all ${l.requires_photo?"left-6 bg-sky":"left-0.5 bg-muted"}`})})]}),M.length>0&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-2 tracking-wide",children:"Assign to Heroes"}),s.jsx("div",{className:"space-y-2",children:M.map(e=>s.jsxs("label",{className:"flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-surface-raised/50 transition-colors",children:[s.jsx("input",{type:"checkbox",checked:l.assigned_user_ids.includes(e.id),onChange:()=>_e(e.id),className:"w-4 h-4 accent-sky"}),s.jsx("span",{className:"text-cream text-sm",children:e.display_name||e.username})]},e.id))})]})]})}),s.jsx(ae,{isOpen:!!y,onClose:()=>k(null),title:"Abandon Quest?",actions:[{label:"Keep Quest",onClick:()=>k(null),className:"game-btn game-btn-blue"},{label:X?"Removing...":"Remove Quest",onClick:ke,className:"game-btn game-btn-red",disabled:X}],children:s.jsxs("p",{className:"text-muted",children:["Are you sure you want to remove the quest"," ",s.jsxs("span",{className:"text-cream text-lg font-bold",children:['"',y==null?void 0:y.title,'"']}),"? This action cannot be undone. All associated records will be archived."]})})]})}export{ns as default};
