import{a as X,u as Z,r as a,b as y,j as e,C as A,e as I}from"./index-CRKPRXQ3.js";import{M as ee}from"./Modal-DXxDxgzi.js";import{C as te}from"./chevron-left-DuB2cF2X.js";import{C as se}from"./chevron-right-D69rsMGZ.js";import{L as ae}from"./loader-circle-C0n6L0S0.js";import{A as re,S as ne}from"./slash-DiIrcwUE.js";import{C as P}from"./clock-oljaRlV0.js";import"./index-C7kt0K0A.js";import"./proxy-DAeV9c_I.js";function q(l){const s=new Date(l),o=s.getDay(),d=s.getDate()-o+(o===0?-6:1);return s.setDate(d),s.toISOString().slice(0,10)}function u(l,s){const o=new Date(l+"T00:00:00");return o.setDate(o.getDate()+s),o.toISOString().slice(0,10)}const ie=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];function oe(l,s){const o=new Date().toISOString().slice(0,10);return l.status==="verified"?{border:"border-emerald",bg:"bg-emerald/10",icon:e.jsx(I,{size:16,className:"text-emerald"})}:l.status==="completed"?{border:"border-emerald",bg:"bg-emerald/5",icon:e.jsx(I,{size:16,className:"text-emerald/60"})}:l.status==="skipped"?{border:"border-border",bg:"bg-navy-light/50",icon:e.jsx(ne,{size:16,className:"text-muted"}),textClass:"line-through text-muted"}:s<o?{border:"border-crimson",bg:"bg-crimson/5",icon:e.jsx(P,{size:16,className:"text-crimson"})}:{border:"border-border",bg:"",icon:e.jsx(P,{size:16,className:"text-muted"})}}function ge(){var O;const l=X(),{user:s}=Z(),o=(s==null?void 0:s.role)==="kid",[d,j]=a.useState(()=>q(new Date)),[w,F]=a.useState({}),[N,S]=a.useState(!0),[v,C]=a.useState(""),[Q,h]=a.useState(!1),[m,R]=a.useState(null),[T,k]=a.useState([]),[b,D]=a.useState(""),[_,z]=a.useState(!1),[E,p]=a.useState(""),x=a.useCallback(async()=>{var t;S(!0),C("");try{const c=await y(`/api/calendar?week_start=${d}`),r={};for(let n=0;n<7;n++){const g=u(d,n);r[g]=((t=c.days)==null?void 0:t[g])||[]}F(r)}catch(c){C(c.message||"Failed to load calendar")}finally{S(!1)}},[d]);a.useEffect(()=>{x()},[x]),a.useEffect(()=>{const t=()=>{x()};return window.addEventListener("ws:message",t),()=>window.removeEventListener("ws:message",t)},[x]);const B=()=>j(u(d,-7)),Y=()=>j(u(d,7)),G=()=>j(q(new Date)),H=async t=>{R(t),p(""),D(""),h(!0);try{const c=await y("/api/admin/users"),r=(c.users||c||[]).filter(n=>n.role==="kid"&&n.id!==s.id&&n.is_active!==!1);k(r)}catch{try{const r=(await y("/api/family/members")||[]).filter(n=>n.role==="kid"&&n.id!==s.id);k(r)}catch{k([])}}},J=async()=>{if(!b){p("Select a hero to trade with");return}z(!0),p("");try{await y("/api/calendar/trade",{method:"POST",body:{assignment_id:m.id,target_user_id:b}}),h(!1),x()}catch(t){p(t.message||"Trade failed")}finally{z(!1)}},U=u(d,6),L=t=>new Date(t+"T00:00:00").toLocaleDateString(void 0,{month:"short",day:"numeric"});return e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(A,{size:28,className:"text-sky"}),e.jsx("h1",{className:"text-cream text-xl font-extrabold leading-relaxed",children:"Quest Calendar"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:B,className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-cream","aria-label":"Previous week",children:e.jsx(te,{size:20})}),e.jsxs("span",{className:"text-cream text-sm min-w-[180px] text-center",children:[L(d)," â€“ ",L(U)]}),e.jsx("button",{onClick:Y,className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-cream","aria-label":"Next week",children:e.jsx(se,{size:20})}),e.jsx("button",{onClick:G,className:"game-btn game-btn-blue ml-2",children:"This Week"})]})]}),v&&e.jsx("div",{className:"mb-4 p-3 rounded border-2 border-crimson/40 bg-crimson/10 text-crimson text-sm text-center",children:v}),N&&e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx(ae,{size:32,className:"text-sky animate-spin"})}),!N&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-7 gap-3",children:ie.map((t,c)=>{const r=u(d,c),n=new Date().toISOString().slice(0,10),g=r===n,$=w[r]||[];return e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:`text-center py-2 px-1 rounded-t-md border-b-2 ${g?"bg-sky/10 border-sky text-sky":"bg-surface-raised/30 border-border text-muted"}`,children:[e.jsx("div",{className:"text-xs font-bold tracking-wider",children:t}),e.jsx("div",{className:"text-sm mt-1",children:new Date(r+"T00:00:00").getDate()})]}),e.jsxs("div",{className:"space-y-2 mt-2 min-h-[80px]",children:[$.length===0&&e.jsx("p",{className:"text-muted text-xs text-center py-4",children:"No quests"}),$.map(i=>{var K,M,W;const f=oe(i,r);return e.jsxs("div",{className:`game-panel !border-2 ${f.border} ${f.bg} p-2 cursor-pointer hover:brightness-110 transition-all`,onClick:()=>l(`/chores/${i.chore_id||i.id}`),children:[e.jsxs("div",{className:"flex items-start gap-1.5",children:[f.icon,e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:`text-sm leading-tight truncate ${f.textClass||"text-cream"}`,children:((K=i.chore)==null?void 0:K.title)||i.chore_title||"Quest"}),!o&&(((M=i.user)==null?void 0:M.display_name)||i.assigned_to_name)&&e.jsx("p",{className:"text-xs text-purple font-medium mt-0.5 truncate",children:((W=i.user)==null?void 0:W.display_name)||i.assigned_to_name})]})]}),o&&i.status==="pending"&&e.jsxs("button",{onClick:V=>{V.stopPropagation(),H(i)},className:"mt-1.5 flex items-center gap-1 text-xs font-medium text-sky hover:text-sky/80 transition-colors",children:[e.jsx(re,{size:12}),"Trade"]})]},i.id)})]})]},r)})}),!N&&!v&&Object.values(w).every(t=>t.length===0)&&e.jsxs("div",{className:"text-center py-16",children:[e.jsx(A,{size:48,className:"text-muted mx-auto mb-4"}),e.jsx("p",{className:"text-cream text-lg font-bold",children:"No quests scheduled this week"}),e.jsx("p",{className:"text-muted text-sm mt-2",children:"The quest board is empty. Time to plan new adventures!"})]}),e.jsx(ee,{isOpen:Q,onClose:()=>h(!1),title:"Propose a Trade",actions:[{label:"Cancel",onClick:()=>h(!1),className:"game-btn game-btn-red"},{label:_?"Sending...":"Send Trade",onClick:J,className:"game-btn game-btn-blue",disabled:_||!b}],children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-muted text-sm",children:["Trade"," ",e.jsx("span",{className:"text-cream font-bold",children:((O=m==null?void 0:m.chore)==null?void 0:O.title)||(m==null?void 0:m.chore_title)||"Quest"})," ","with another hero:"]}),E&&e.jsx("div",{className:"p-2 rounded border border-crimson/40 bg-crimson/10 text-crimson text-sm",children:E}),T.length===0?e.jsx("p",{className:"text-muted text-sm",children:"No other heroes found in your party."}):e.jsx("div",{className:"space-y-2",children:T.map(t=>e.jsx("button",{onClick:()=>D(t.id),className:`w-full text-left p-3 rounded border-2 transition-colors ${b===t.id?"border-sky bg-sky/10 text-sky":"border-border text-muted hover:border-cream/30"}`,children:e.jsx("span",{className:"text-sm",children:t.display_name||t.username})},t.id))})]})})]})}export{ge as default};
